<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Branch Monkey</title>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=SF+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'system-ui', 'sans-serif'],
            mono: ['SF Mono', 'Menlo', 'Monaco', 'Consolas', 'monospace']
          },
          colors: {
            apple: {
              bg: '#000000',
              surface: '#1c1c1e',
              elevated: '#2c2c2e',
              separator: '#38383a',
              label: '#ffffff',
              secondary: '#8e8e93',
              tertiary: '#48484a',
              blue: '#0a84ff',
              green: '#30d158',
              orange: '#ff9f0a',
              red: '#ff453a',
              purple: '#bf5af2',
              pink: '#ff375f',
              cyan: '#64d2ff',
              yellow: '#ffd60a'
            }
          }
        }
      }
    }
  </script>
  <style>
    [x-cloak] { display: none !important; }

    * {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body {
      background: #000000;
    }

    .surface {
      background: rgba(28, 28, 30, 0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    .elevated {
      background: rgba(44, 44, 46, 0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    .card {
      background: rgba(28, 28, 30, 0.6);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 0.5px solid rgba(255, 255, 255, 0.1);
      transition: all 0.2s ease;
    }

    .card:hover {
      background: rgba(44, 44, 46, 0.6);
    }

    .btn {
      transition: all 0.15s ease;
    }

    .btn:active {
      transform: scale(0.97);
    }

    .btn-primary {
      background: #0a84ff;
    }
    .btn-primary:hover {
      background: #409cff;
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
    }
    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .btn-danger {
      background: rgba(255, 69, 58, 0.15);
      color: #ff453a;
    }
    .btn-danger:hover {
      background: rgba(255, 69, 58, 0.25);
    }

    .btn-success {
      background: rgba(48, 209, 88, 0.15);
      color: #30d158;
    }
    .btn-success:hover {
      background: rgba(48, 209, 88, 0.25);
    }

    .output-scroll {
      max-height: 300px;
      overflow-y: auto;
    }
    .output-scroll::-webkit-scrollbar { width: 6px; }
    .output-scroll::-webkit-scrollbar-track { background: transparent; }
    .output-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
    .output-scroll::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }

    .tab {
      position: relative;
      transition: all 0.2s ease;
    }
    .tab.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 20px;
      height: 2px;
      background: #0a84ff;
      border-radius: 1px;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 100px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-running {
      background: rgba(48, 209, 88, 0.15);
      color: #30d158;
    }
    .status-paused {
      background: rgba(255, 159, 10, 0.15);
      color: #ff9f0a;
    }
    .status-completed {
      background: rgba(10, 132, 255, 0.15);
      color: #0a84ff;
    }
    .status-failed, .status-stopped {
      background: rgba(255, 69, 58, 0.15);
      color: #ff453a;
    }

    .diff-add { color: #30d158; background: rgba(48, 209, 88, 0.1); }
    .diff-del { color: #ff453a; background: rgba(255, 69, 58, 0.1); }
    .diff-hunk { color: #bf5af2; }

    .commit-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #0a84ff;
      position: relative;
    }
    .commit-dot.merge {
      background: #bf5af2;
    }
    .commit-line {
      position: relative;
    }
    .commit-line::before {
      content: '';
      position: absolute;
      left: 3.5px;
      top: 20px;
      bottom: -16px;
      width: 1px;
      background: rgba(255, 255, 255, 0.1);
    }
    .commit-line:last-child::before {
      display: none;
    }

    @keyframes pulse-ring {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(1.5); opacity: 0; }
    }
    .pulse-ring::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: inherit;
      animation: pulse-ring 1.5s ease-out infinite;
    }

    input:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.3);
    }

    .mono {
      font-family: 'SF Mono', Menlo, Monaco, Consolas, monospace;
    }
  </style>
</head>
<body class="text-white min-h-screen font-sans">
  <div x-data="dashboard()" x-init="init()" x-cloak class="min-h-screen">
    <!-- Header -->
    <header class="surface border-b border-white/5 sticky top-0 z-50">
      <div class="max-w-6xl mx-auto px-6 h-14 flex items-center justify-between">
        <div class="flex items-center gap-8">
          <div class="flex items-center gap-2.5">
            <span class="font-semibold text-[15px]" x-text="appName"></span>
          </div>

          <div class="flex items-center gap-4 text-[13px]">
            <div class="flex items-center gap-2">
              <div class="relative">
                <div :class="connected ? 'bg-apple-green' : 'bg-apple-red'" class="w-2 h-2 rounded-full"></div>
                <div x-show="connected" :class="connected ? 'bg-apple-green' : ''" class="absolute inset-0 w-2 h-2 rounded-full pulse-ring"></div>
              </div>
              <span class="text-apple-secondary" x-text="connected ? 'Connected' : 'Disconnected'"></span>
            </div>
            <div class="w-px h-3 bg-white/10"></div>
            <div class="flex items-center gap-1.5">
              <svg :class="claudeInstalled ? 'text-apple-green' : 'text-apple-orange'" class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                <path x-show="claudeInstalled" fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                <path x-show="!claudeInstalled" fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
              </svg>
              <span class="text-apple-secondary">Claude CLI</span>
            </div>
          </div>
        </div>

        <button @click="refreshAll()" class="p-2 -m-2 hover:bg-white/5 rounded-lg transition-colors">
          <svg class="w-4 h-4 text-apple-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
        </button>
      </div>
    </header>

    <!-- Tabs -->
    <nav class="surface border-b border-white/5 sticky top-14 z-40">
      <div class="max-w-6xl mx-auto px-6 flex gap-6">
        <template x-for="t in [
          {id: 'relay', label: 'Overview'},
          {id: 'agents', label: 'Agents'},
          {id: 'worktrees', label: 'Worktrees'},
          {id: 'devServers', label: 'Dev Servers'},
          {id: 'gitHistory', label: 'Git History'},
          {id: 'api', label: 'API'}
        ]">
          <button
            @click="activeTab = t.id"
            :class="activeTab === t.id ? 'text-white active' : 'text-apple-secondary hover:text-white'"
            class="tab py-3 text-[13px] font-medium transition-colors"
            x-text="t.label"
          ></button>
        </template>
      </div>
    </nav>

    <!-- Content -->
    <main class="max-w-6xl mx-auto px-6 py-6">
      <!-- Relay Overview / Architecture Diagram -->
      <div x-show="activeTab === 'relay'" x-cloak>
        <div class="flex flex-col items-center py-4">
          <!-- Cloud Layer -->
          <div class="relative">
            <div class="card rounded-2xl p-5 min-w-[280px] text-center border-apple-blue/30">
              <div class="flex items-center justify-center gap-3 mb-2">
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-apple-blue to-apple-purple flex items-center justify-center">
                  <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/>
                  </svg>
                </div>
                <div class="text-left">
                  <div class="font-semibold text-lg" x-text="appName + ' Cloud'"></div>
                  <div class="text-xs text-apple-secondary" x-text="appDomain || cloudUrl?.replace('https://', '') || 'p-63-branch-monkey.pages.dev'"></div>
                </div>
              </div>
              <div class="flex items-center justify-center gap-2 mt-3">
                <button @click="checkCloudStatus()" class="btn btn-secondary px-3 py-1.5 rounded-lg text-xs">
                  Check Status
                </button>
                <div class="status-pill" :class="cloudReachable === true ? 'status-running' : cloudReachable === false ? 'status-failed' : 'bg-white/10 text-apple-secondary'">
                  <span class="w-1.5 h-1.5 rounded-full bg-current" :class="cloudReachable === true ? 'animate-pulse' : ''"></span>
                  <span x-text="cloudReachable === true ? 'Reachable' : cloudReachable === false ? 'Unreachable' : 'Unknown'"></span>
                </div>
              </div>
            </div>
          </div>

          <!-- Connection Line: Cloud to Relay -->
          <div class="flex flex-col items-center py-2">
            <div class="w-px h-8 bg-gradient-to-b from-apple-blue/50 to-apple-yellow/50"></div>
            <div class="px-3 py-1 rounded-full bg-apple-yellow/10 border border-apple-yellow/30 text-[10px] text-apple-yellow font-medium">
              Supabase Realtime
            </div>
            <div class="w-px h-8 bg-gradient-to-b from-apple-yellow/50 to-apple-green/50"></div>
          </div>

          <!-- Relay Client Layer -->
          <div class="relative">
            <div class="card rounded-2xl p-5 min-w-[280px] text-center" :class="relayConnected ? 'border-apple-green/30' : 'border-apple-orange/30'">
              <div class="flex items-center justify-center gap-3 mb-2">
                <div class="w-12 h-12 rounded-xl flex items-center justify-center" :class="relayConnected ? 'bg-apple-green/20' : 'bg-apple-orange/20'">
                  <svg class="w-6 h-6" :class="relayConnected ? 'text-apple-green' : 'text-apple-orange'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                  </svg>
                </div>
                <div class="text-left">
                  <div class="font-semibold text-lg">Relay Client</div>
                  <div class="text-xs text-apple-secondary" x-text="relayInfo?.machine_name || 'branch-monkey-relay'"></div>
                </div>
              </div>
              <div class="flex items-center justify-center gap-2 mt-3">
                <div class="status-pill" :class="relayConnected ? 'status-running' : 'status-paused'">
                  <span class="w-1.5 h-1.5 rounded-full bg-current" :class="relayConnected ? 'animate-pulse' : ''"></span>
                  <span x-text="relayConnected ? 'Connected' : 'Not Running'"></span>
                </div>
              </div>
              <!-- Connected: show cloud URL and controls -->
              <div x-show="relayConnected && relayInfo?.cloud_url" class="mt-3 text-xs text-apple-secondary">
                <span class="text-apple-tertiary">Cloud:</span> <span class="text-apple-cyan" x-text="relayInfo?.cloud_url?.replace('https://', '')"></span>
              </div>
              <!-- Relay controls -->
              <div class="flex items-center justify-center gap-2 mt-3">
                <button @click="refreshRelayStatus()" class="flex items-center gap-1.5 btn btn-secondary px-3 py-1.5 rounded-lg text-xs" title="Refresh status">
                  <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                  </svg>
                  <span>Refresh</span>
                </button>
                <button x-show="relayConnected" @click="disconnectRelay()" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs bg-apple-red/20 text-apple-red hover:bg-apple-red/30 transition-colors" title="Disconnect relay">
                  <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>
                  </svg>
                  <span>Disconnect</span>
                </button>
              </div>
              <!-- Not connected: show command to run -->
              <div x-show="!relayConnected" class="mt-3 text-xs text-apple-tertiary">
                Run: <code class="mono text-apple-cyan">branch-monkey-relay</code>
              </div>
            </div>
          </div>

          <!-- Connection Line: Relay to Local Server -->
          <div class="flex flex-col items-center py-2">
            <div class="w-px h-8 bg-gradient-to-b from-apple-green/50 to-apple-cyan/50"></div>
            <div class="px-3 py-1 rounded-full bg-apple-cyan/10 border border-apple-cyan/30 text-[10px] text-apple-cyan font-medium">
              HTTP localhost:18081
            </div>
            <div class="w-px h-8 bg-gradient-to-b from-apple-cyan/50 to-apple-purple/50"></div>
          </div>

          <!-- Local Server Layer -->
          <div class="relative">
            <div class="card rounded-2xl p-5 min-w-[280px] text-center border-apple-green/30">
              <div class="flex items-center justify-center gap-3 mb-2">
                <div class="w-12 h-12 rounded-xl bg-apple-green/20 flex items-center justify-center">
                  <svg class="w-6 h-6 text-apple-green" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"/>
                  </svg>
                </div>
                <div class="text-left">
                  <div class="font-semibold text-lg">Local Server</div>
                  <div class="text-xs text-apple-secondary" x-text="'http://localhost:18081'"></div>
                </div>
              </div>
              <div class="flex items-center justify-center gap-2 mt-3">
                <div class="status-pill status-running">
                  <span class="w-1.5 h-1.5 rounded-full bg-current animate-pulse"></span>
                  <span>Running</span>
                </div>
                <div x-show="claudeInstalled" class="status-pill bg-apple-purple/15 text-apple-purple">
                  <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>
                  <span>Claude CLI</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Kompany Home Section -->
          <div class="w-full max-w-xl mt-4">
            <div class="card rounded-xl p-4">
              <div class="flex items-center gap-2 mb-3">
                <div class="w-8 h-8 rounded-lg bg-apple-purple/15 flex items-center justify-center">
                  <svg class="w-4 h-4 text-apple-purple" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                  </svg>
                </div>
                <div class="flex-1">
                  <div class="font-medium text-sm" x-text="appName + ' Home'">Kompany Home</div>
                  <div class="text-[10px] text-apple-secondary">Base directory for all projects</div>
                </div>
                <button @click="openDirectoryModal('home')" class="btn btn-secondary px-3 py-1.5 rounded-lg text-xs">
                  Change
                </button>
              </div>
              <div class="bg-black/30 rounded-lg p-3">
                <span class="mono text-xs text-apple-purple truncate" x-text="workingDirInfo?.home_directory || workingDirectory || 'Not configured'"></span>
              </div>
            </div>
          </div>

          <!-- Connection Line: Home to Project -->
          <div class="flex flex-col items-center py-2">
            <div class="w-px h-6 bg-gradient-to-b from-apple-purple/50 to-apple-yellow/50"></div>
          </div>

          <!-- Current Project Directory Section -->
          <div class="w-full max-w-xl">
            <div class="card rounded-xl p-4">
              <div class="flex items-center gap-2 mb-3">
                <div class="w-8 h-8 rounded-lg bg-apple-yellow/15 flex items-center justify-center">
                  <svg class="w-4 h-4 text-apple-yellow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                  </svg>
                </div>
                <div class="flex-1">
                  <div class="font-medium text-sm">Current Project</div>
                  <div class="text-[10px] text-apple-secondary">Working directory for agents and worktrees</div>
                </div>
                <button x-show="hasProjectSelected" @click="openDirectoryModal('project')" class="btn btn-secondary px-3 py-1.5 rounded-lg text-xs">
                  Change
                </button>
              </div>

              <!-- No project selected - show discovered projects -->
              <div x-show="!hasProjectSelected" class="space-y-3">
                <div class="flex items-center justify-between">
                  <div class="text-sm text-apple-secondary">Select a project to get started</div>
                  <button @click="refreshDiscoveredProjects()" class="text-xs text-apple-cyan hover:underline flex items-center gap-1">
                    <svg class="w-3 h-3" :class="loadingProjects ? 'animate-spin' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Refresh
                  </button>
                </div>
                <div x-show="loadingProjects" class="text-center py-4 text-apple-secondary text-xs">
                  Loading projects...
                </div>
                <div x-show="!loadingProjects && discoveredProjects.length === 0" class="text-center py-4 text-apple-tertiary text-xs">
                  No projects found
                </div>
                <div x-show="!loadingProjects && discoveredProjects.length > 0" class="grid grid-cols-2 gap-2 max-h-[300px] overflow-y-auto">
                  <template x-for="project in discoveredProjects" :key="project.path">
                    <button @click="selectProject(project.path)"
                            class="flex items-center gap-2 bg-black/30 hover:bg-apple-yellow/10 rounded-lg px-3 py-2 text-left transition-colors border border-transparent hover:border-apple-yellow/30">
                      <svg class="w-4 h-4 text-apple-yellow flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                      </svg>
                      <div class="min-w-0 flex-1">
                        <div class="text-xs font-medium truncate" x-text="project.name"></div>
                        <div class="text-[10px] text-apple-tertiary truncate" x-text="project.parent"></div>
                      </div>
                    </button>
                  </template>
                </div>
              </div>

              <!-- Project selected - show details -->
              <div x-show="hasProjectSelected" class="bg-black/30 rounded-lg p-3">
                <div class="flex items-center gap-2">
                  <span class="mono text-xs text-apple-cyan truncate flex-1" x-text="workingDirectory"></span>
                  <span x-show="workingDirInfo?.is_git_repo" class="text-[10px] px-2 py-0.5 rounded-full bg-apple-green/15 text-apple-green">Git</span>
                  <button @click="clearProject()" class="p-1 hover:bg-white/10 rounded transition-colors" title="Clear project selection">
                    <svg class="w-4 h-4 text-apple-secondary hover:text-apple-red" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                  </button>
                </div>
                <div x-show="workingDirInfo?.worktree_count > 0" class="text-[10px] text-apple-secondary mt-2">
                  <span x-text="workingDirInfo?.worktree_count"></span> worktrees found
                </div>
              </div>
            </div>
          </div>

          <!-- Connection Line to Worktrees -->
          <div class="flex flex-col items-center py-2">
            <div class="w-px h-8 bg-gradient-to-b from-apple-purple/50 to-apple-cyan/50"></div>
            <div class="px-3 py-1 rounded-full bg-apple-cyan/10 border border-apple-cyan/30 text-[10px] text-apple-cyan font-medium">
              Git Worktrees
            </div>
            <div class="w-px h-4 bg-apple-cyan/30"></div>
          </div>

          <!-- Worktrees Container -->
          <div class="w-full max-w-5xl">
            <div class="card rounded-2xl p-4 border-apple-cyan/20">
              <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                  <div class="w-8 h-8 rounded-lg bg-apple-cyan/15 flex items-center justify-center">
                    <svg class="w-4 h-4 text-apple-cyan" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                    </svg>
                  </div>
                  <div>
                    <div class="font-medium">Worktrees</div>
                    <div class="text-[10px] text-apple-secondary">Isolated environments for parallel development</div>
                  </div>
                </div>
                <div class="text-sm font-semibold" :class="worktrees.length > 0 ? 'text-apple-cyan' : 'text-apple-tertiary'" x-text="worktrees.length + ' active'"></div>
              </div>

              <!-- Worktrees Grid -->
              <div x-show="worktrees.length === 0" class="text-center py-8 text-apple-tertiary text-sm">
                No worktrees active. Start an agent to create one.
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                <template x-for="wt in [...worktrees].sort((a, b) => (b.task_number || 0) - (a.task_number || 0))" :key="wt.path">
                  <div class="bg-black/30 rounded-xl p-4 border border-white/5 hover:border-apple-cyan/30 transition-colors">
                    <!-- Worktree Header -->
                    <div class="flex items-center justify-between mb-3">
                      <div class="flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full" :class="wt.merged_to_main ? 'bg-apple-green' : wt.has_changes ? 'bg-apple-orange animate-pulse' : 'bg-apple-cyan'"></span>
                        <span class="mono text-sm font-medium cursor-pointer hover:text-apple-cyan transition-colors"
                              :class="wt.showFullName ? '' : 'truncate max-w-[150px]'"
                              :title="wt.path"
                              @click="wt.showFullName = !wt.showFullName"
                              x-text="wt.branch || 'detached'"></span>
                      </div>
                      <span class="text-[10px] px-2 py-0.5 rounded-full"
                            :class="wt.merged_to_main ? 'bg-apple-green/15 text-apple-green' : wt.has_changes ? 'bg-apple-orange/15 text-apple-orange' : 'bg-white/5 text-apple-secondary'"
                            x-text="wt.merged_to_main ? 'Merged' : wt.has_changes ? 'Modified' : 'Clean'"></span>
                    </div>

                    <!-- Task Number -->
                    <div x-show="wt.task_number" class="text-xs text-apple-secondary mb-3">
                      Task #<span x-text="wt.task_number"></span>
                    </div>

                    <!-- Agent inside this worktree -->
                    <div class="space-y-2">
                      <template x-for="agent in agents.filter(a => a.worktree_path ? a.worktree_path === wt.path : (wt.task_number && a.task_number == wt.task_number))" :key="agent.id">
                        <div class="flex items-center gap-2 bg-apple-blue/10 rounded-lg px-3 py-2 border border-apple-blue/20">
                          <div class="w-6 h-6 rounded-md bg-apple-blue/20 flex items-center justify-center">
                            <svg class="w-3 h-3 text-apple-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                            </svg>
                          </div>
                          <div class="flex-1 min-w-0">
                            <div class="text-xs font-medium truncate" x-text="agent.task_title || 'Agent'"></div>
                            <div class="text-[10px] text-apple-secondary" x-text="agent.status"></div>
                          </div>
                          <span class="w-1.5 h-1.5 rounded-full" :class="{
                            'bg-apple-green animate-pulse': agent.status === 'running',
                            'bg-apple-orange': agent.status === 'paused',
                            'bg-apple-blue': agent.status === 'completed',
                            'bg-apple-red': agent.status === 'failed'
                          }"></span>
                        </div>
                      </template>

                      <!-- Dev Server inside this worktree -->
                      <template x-for="server in devServers.filter(s => s.worktreePath === wt.path)" :key="server.runId">
                        <div class="flex items-center gap-2 bg-apple-orange/10 rounded-lg px-3 py-2 border border-apple-orange/20">
                          <div class="w-6 h-6 rounded-md bg-apple-orange/20 flex items-center justify-center">
                            <svg class="w-3 h-3 text-apple-orange" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                          </div>
                          <div class="flex-1 min-w-0">
                            <div class="text-xs font-medium">Dev Server</div>
                            <div class="text-[10px] text-apple-secondary mono" x-text="'localhost:' + server.port"></div>
                          </div>
                          <a :href="server.url" target="_blank"
                             class="px-2 py-1 rounded-md bg-apple-orange/20 hover:bg-apple-orange/30 text-[10px] text-apple-orange font-medium transition-colors">
                            Open
                          </a>
                          <span class="w-1.5 h-1.5 rounded-full bg-apple-green animate-pulse"></span>
                        </div>
                      </template>

                      <!-- Empty state for worktree with no agent/server -->
                      <template x-if="!agents.some(a => a.worktree_path ? a.worktree_path === wt.path : (wt.task_number && a.task_number == wt.task_number)) && !devServers.some(s => s.worktreePath === wt.path)">
                        <div class="text-[10px] text-apple-tertiary text-center py-2">No active processes</div>
                      </template>
                    </div>

                    <!-- Last Commit -->
                    <div x-show="wt.last_commit" class="mt-3 pt-3 border-t border-white/5">
                      <div class="flex items-center gap-2 text-[10px]">
                        <span class="mono text-apple-yellow" x-text="wt.last_commit?.hash"></span>
                        <span class="text-apple-secondary truncate" x-text="wt.last_commit?.message"></span>
                      </div>
                    </div>
                  </div>
                </template>
              </div>
            </div>
          </div>

          <!-- Orphan Agents (not in any worktree) -->
          <template x-if="agents.filter(a => !worktrees.some(wt => a.worktree_path ? a.worktree_path === wt.path : (wt.task_number && a.task_number == wt.task_number))).length > 0">
            <div class="w-full max-w-5xl mt-4">
              <div class="card rounded-xl p-4 border-apple-blue/20">
                <div class="flex items-center gap-2 mb-3">
                  <div class="w-6 h-6 rounded-lg bg-apple-blue/15 flex items-center justify-center">
                    <svg class="w-3 h-3 text-apple-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                  </div>
                  <div class="text-sm font-medium">Standalone Agents</div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                  <template x-for="agent in agents.filter(a => !worktrees.some(wt => a.worktree_path ? a.worktree_path === wt.path : (wt.task_number && a.task_number == wt.task_number)))" :key="agent.id">
                    <div class="flex items-center gap-2 bg-black/20 rounded-lg px-3 py-2">
                      <span class="w-1.5 h-1.5 rounded-full" :class="{
                        'bg-apple-green animate-pulse': agent.status === 'running',
                        'bg-apple-orange': agent.status === 'paused',
                        'bg-apple-blue': agent.status === 'completed',
                        'bg-apple-red': agent.status === 'failed'
                      }"></span>
                      <span class="text-xs truncate" x-text="agent.task_title || agent.id"></span>
                    </div>
                  </template>
                </div>
              </div>
            </div>
          </template>

          <!-- Summary Stats -->
          <div class="mt-8 w-full max-w-4xl">
            <div class="card rounded-xl p-4">
              <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-center">
                <div>
                  <div class="text-2xl font-bold" :class="connected ? 'text-apple-green' : 'text-apple-red'" x-text="connected ? '●' : '○'"></div>
                  <div class="text-xs text-apple-secondary mt-1">Server</div>
                </div>
                <div>
                  <div class="text-2xl font-bold" :class="claudeInstalled ? 'text-apple-purple' : 'text-apple-tertiary'" x-text="claudeInstalled ? '●' : '○'"></div>
                  <div class="text-xs text-apple-secondary mt-1">Claude CLI</div>
                </div>
                <div>
                  <div class="text-2xl font-bold text-apple-blue" x-text="agents.filter(a => a.status === 'running').length"></div>
                  <div class="text-xs text-apple-secondary mt-1">Active Agents</div>
                </div>
                <div>
                  <div class="text-2xl font-bold text-apple-cyan" x-text="worktrees.filter(w => !w.merged_to_main).length"></div>
                  <div class="text-xs text-apple-secondary mt-1">Open Branches</div>
                </div>
                <div>
                  <div class="text-2xl font-bold text-apple-orange" x-text="devServers.length"></div>
                  <div class="text-xs text-apple-secondary mt-1">Dev Servers</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Agents -->
      <div x-show="activeTab === 'agents'" x-cloak>
        <div x-show="agents.length === 0" class="text-center py-20">
          <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-apple-surface flex items-center justify-center">
            <svg class="w-8 h-8 text-apple-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
            </svg>
          </div>
          <h3 class="text-lg font-semibold mb-1">No Agents Running</h3>
          <p class="text-apple-secondary text-sm">Start an agent from Claude Code or the relay</p>
        </div>

        <div class="space-y-3">
          <template x-for="agent in agents" :key="agent.id">
            <div class="card rounded-2xl overflow-hidden">
              <div class="p-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-xl flex items-center justify-center"
                       :class="{
                         'bg-apple-green/15': agent.status === 'running',
                         'bg-apple-orange/15': agent.status === 'paused',
                         'bg-apple-blue/15': agent.status === 'completed',
                         'bg-apple-red/15': agent.status === 'failed' || agent.status === 'stopped'
                       }">
                    <svg class="w-5 h-5"
                         :class="{
                           'text-apple-green': agent.status === 'running',
                           'text-apple-orange': agent.status === 'paused',
                           'text-apple-blue': agent.status === 'completed',
                           'text-apple-red': agent.status === 'failed' || agent.status === 'stopped'
                         }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                  </div>
                  <div>
                    <div class="flex items-center gap-2">
                      <span class="font-medium text-[15px]" x-text="agent.task_title || 'Agent ' + agent.id"></span>
                      <span x-show="agent.task_number" class="mono text-xs text-apple-secondary bg-white/5 px-1.5 py-0.5 rounded" x-text="'#' + agent.task_number"></span>
                    </div>
                    <div class="flex items-center gap-2 mt-0.5">
                      <span class="mono text-xs text-apple-tertiary" x-text="agent.id"></span>
                      <span x-show="agent.branch" class="text-xs text-apple-purple" x-text="agent.branch"></span>
                    </div>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <span class="status-pill"
                        :class="{
                          'status-running': agent.status === 'running',
                          'status-paused': agent.status === 'paused',
                          'status-completed': agent.status === 'completed',
                          'status-failed': agent.status === 'failed' || agent.status === 'stopped'
                        }">
                    <span :class="agent.status === 'running' ? 'animate-pulse' : ''" class="w-1.5 h-1.5 rounded-full bg-current"></span>
                    <span x-text="agent.status" class="capitalize"></span>
                  </span>
                  <button @click="killAgent(agent.id)" class="btn btn-danger px-3 py-1.5 rounded-lg text-xs font-medium">
                    Stop
                  </button>
                </div>
              </div>

              <div class="px-4 pb-4">
                <div class="bg-black/40 rounded-xl p-3 output-scroll mono text-xs leading-relaxed"
                     :id="'output-' + agent.id"
                     x-html="formatOutput(agentOutput[agent.id] || [])">
                </div>
              </div>

              <div x-show="agent.can_resume && agent.status !== 'running'" class="px-4 pb-4">
                <div class="flex gap-2">
                  <input
                    type="text"
                    x-model="inputMessages[agent.id]"
                    @keyup.enter="sendInput(agent.id)"
                    placeholder="Send follow-up..."
                    class="flex-1 bg-white/5 border border-white/10 rounded-xl px-3 py-2 text-sm placeholder-apple-tertiary transition-all"
                  >
                  <button @click="sendInput(agent.id)" class="btn btn-primary px-4 py-2 rounded-xl text-sm font-medium">
                    Send
                  </button>
                </div>
              </div>
            </div>
          </template>
        </div>
      </div>

      <!-- Worktrees -->
      <div x-show="activeTab === 'worktrees'" x-cloak>
        <div x-show="worktrees.length === 0" class="text-center py-20">
          <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-apple-surface flex items-center justify-center">
            <svg class="w-8 h-8 text-apple-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
            </svg>
          </div>
          <h3 class="text-lg font-semibold mb-1">No Worktrees</h3>
          <p class="text-apple-secondary text-sm">Worktrees are created when agents start tasks</p>
        </div>

        <div class="space-y-2">
          <template x-for="wt in [...worktrees].sort((a, b) => (b.task_number || 0) - (a.task_number || 0))" :key="wt.path">
            <div class="card rounded-xl p-4">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="w-9 h-9 rounded-lg flex items-center justify-center"
                       :class="wt.merged_to_main ? 'bg-apple-green/15' : 'bg-apple-cyan/15'">
                    <svg class="w-4.5 h-4.5"
                         :class="wt.merged_to_main ? 'text-apple-green' : 'text-apple-cyan'"
                         fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                    </svg>
                  </div>
                  <div>
                    <div class="flex items-center gap-2">
                      <span class="mono text-sm font-medium" :title="wt.path" x-text="wt.branch || 'detached'"></span>
                      <span x-show="wt.task_number" class="text-xs text-apple-secondary bg-white/5 px-1.5 py-0.5 rounded" x-text="'Task #' + wt.task_number"></span>
                      <span x-show="wt.has_changes" class="text-[10px] px-1.5 py-0.5 rounded-full bg-apple-orange/15 text-apple-orange">Modified</span>
                      <span x-show="wt.merged_to_main" class="text-[10px] px-1.5 py-0.5 rounded-full bg-apple-green/15 text-apple-green">Merged</span>
                    </div>
                    <div x-show="wt.last_commit" class="flex items-center gap-2 mt-1 text-xs text-apple-secondary">
                      <span class="mono text-apple-yellow" x-text="wt.last_commit?.hash"></span>
                      <span class="truncate max-w-xs" x-text="wt.last_commit?.message"></span>
                      <span x-text="wt.last_commit?.date"></span>
                    </div>
                  </div>
                </div>
                <div class="flex items-center gap-1.5">
                  <button @click="openInEditor(wt.task_number)" class="btn btn-secondary px-3 py-1.5 rounded-lg text-xs font-medium">
                    Open
                  </button>
                  <button x-show="!wt.merged_to_main && wt.branch" @click="mergeWorktree(wt)" class="btn btn-success px-3 py-1.5 rounded-lg text-xs font-medium">
                    Merge
                  </button>
                  <button @click="deleteWorktree(wt)" class="btn btn-danger px-3 py-1.5 rounded-lg text-xs font-medium">
                    Delete
                  </button>
                </div>
              </div>
            </div>
          </template>
        </div>
      </div>

      <!-- Dev Servers -->
      <div x-show="activeTab === 'devServers'" x-cloak>
        <div class="space-y-4">
          <!-- Proxy Card -->
          <div class="card rounded-xl p-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-lg bg-apple-purple/15 flex items-center justify-center">
                  <svg class="w-4.5 h-4.5 text-apple-purple" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                  </svg>
                </div>
                <div>
                  <div class="font-medium text-sm">Dev Proxy</div>
                  <div class="flex items-center gap-2 mt-0.5 text-xs">
                    <span :class="proxyStatus.running ? 'text-apple-green' : 'text-apple-secondary'" x-text="proxyStatus.running ? 'Active' : 'Inactive'"></span>
                    <template x-if="proxyStatus.running">
                      <span class="text-apple-secondary">
                        <span class="mono">:<span x-text="proxyStatus.proxyPort"></span></span>
                        <template x-if="proxyStatus.targetPort">
                          <span> → <span class="mono">:<span x-text="proxyStatus.targetPort"></span></span></span>
                        </template>
                      </span>
                    </template>
                  </div>
                </div>
              </div>
              <a x-show="proxyStatus.proxyUrl" :href="proxyStatus.proxyUrl" target="_blank" class="btn btn-primary px-3 py-1.5 rounded-lg text-xs font-medium">
                Open
              </a>
            </div>
          </div>

          <div x-show="devServers.length === 0" class="text-center py-16">
            <div class="w-14 h-14 mx-auto mb-3 rounded-2xl bg-apple-surface flex items-center justify-center">
              <svg class="w-7 h-7 text-apple-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2"/>
              </svg>
            </div>
            <h3 class="font-semibold mb-1">No Dev Servers</h3>
            <p class="text-apple-secondary text-sm">Start a server from a worktree</p>
          </div>

          <div class="space-y-2">
            <template x-for="server in devServers" :key="server.runId">
              <div class="card rounded-xl p-4">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-lg flex items-center justify-center"
                         :class="server.isActive ? 'bg-apple-green/15' : 'bg-white/5'">
                      <svg class="w-4.5 h-4.5" :class="server.isActive ? 'text-apple-green' : 'text-apple-secondary'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2"/>
                      </svg>
                    </div>
                    <div>
                      <div class="flex items-center gap-2">
                        <span class="font-medium text-sm" x-text="'Task #' + server.taskNumber"></span>
                        <span class="mono text-xs text-apple-cyan" x-text="':' + server.port"></span>
                        <span x-show="server.isActive" class="text-[10px] px-1.5 py-0.5 rounded-full bg-apple-green/15 text-apple-green animate-pulse">Proxied</span>
                      </div>
                      <div class="text-xs text-apple-tertiary mt-0.5" x-text="server.startedAt"></div>
                    </div>
                  </div>
                  <div class="flex items-center gap-1.5">
                    <button x-show="!server.isActive" @click="setProxyTarget(server.runId)" class="btn btn-secondary px-3 py-1.5 rounded-lg text-xs font-medium">
                      Set Proxy
                    </button>
                    <a :href="server.url" target="_blank" class="btn btn-secondary px-3 py-1.5 rounded-lg text-xs font-medium">
                      Direct
                    </a>
                    <button @click="stopDevServer(server.runId)" class="btn btn-danger px-3 py-1.5 rounded-lg text-xs font-medium">
                      Stop
                    </button>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </div>
      </div>

      <!-- Git History -->
      <div x-show="activeTab === 'gitHistory'" x-cloak>
        <div class="space-y-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3 text-sm">
              <span class="text-apple-secondary">Branch:</span>
              <span class="mono text-apple-purple" x-text="currentBranch"></span>
            </div>
            <label class="flex items-center gap-2 text-sm cursor-pointer">
              <input type="checkbox" x-model="showAllBranches" @change="refreshCommits()" class="w-4 h-4 rounded bg-white/10 border-0 text-apple-blue focus:ring-apple-blue/30">
              <span class="text-apple-secondary">All branches</span>
            </label>
          </div>

          <div class="card rounded-xl overflow-hidden divide-y divide-white/5">
            <template x-for="(commit, index) in commits" :key="commit.hash">
              <div @click="selectCommit(commit)"
                   :class="selectedCommit?.hash === commit.hash ? 'bg-apple-blue/10' : 'hover:bg-white/[0.02]'"
                   class="px-4 py-3 cursor-pointer transition-colors commit-line">
                <div class="flex items-start gap-3">
                  <div class="pt-1">
                    <div class="commit-dot" :class="commit.parents?.length > 1 ? 'merge' : ''"></div>
                  </div>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-1">
                      <span class="mono text-xs text-apple-yellow" x-text="commit.short_hash"></span>
                      <span class="text-sm truncate" x-text="commit.message"></span>
                    </div>
                    <div class="flex items-center gap-3 text-xs text-apple-secondary">
                      <span x-text="commit.author"></span>
                      <span x-text="commit.relative_date"></span>
                      <template x-if="commit.refs">
                        <div class="flex gap-1">
                          <template x-for="ref in commit.refs.split(', ').filter(r => r)" :key="ref">
                            <span class="px-1.5 py-0.5 rounded text-[10px] font-medium"
                                  :class="ref.includes('HEAD') ? 'bg-apple-green/20 text-apple-green' : ref.includes('origin/') ? 'bg-apple-purple/20 text-apple-purple' : 'bg-apple-blue/20 text-apple-blue'"
                                  x-text="ref.replace('HEAD -> ', '')"></span>
                          </template>
                        </div>
                      </template>
                    </div>
                  </div>
                  <div class="flex items-center gap-1">
                    <button @click.stop="viewDiff(commit)" class="btn btn-secondary p-1.5 rounded-lg">
                      <svg class="w-4 h-4 text-apple-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                      </svg>
                    </button>
                    <button @click.stop="previewCommit(commit)" class="btn btn-secondary p-1.5 rounded-lg">
                      <svg class="w-4 h-4 text-apple-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </template>
          </div>

          <div x-show="previews.length > 0">
            <h3 class="text-xs font-medium text-apple-secondary uppercase tracking-wide mb-2">Active Previews</h3>
            <div class="space-y-2">
              <template x-for="preview in previews" :key="preview.sha">
                <div class="card rounded-xl p-3 flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <span class="mono text-xs text-apple-yellow" x-text="preview.sha"></span>
                    <a :href="preview.url" target="_blank" class="mono text-xs text-apple-blue hover:underline" x-text="preview.url"></a>
                  </div>
                  <button @click="deletePreview(preview.sha)" class="btn btn-danger px-2 py-1 rounded text-xs">Stop</button>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>

      <!-- API Documentation -->
      <div x-show="activeTab === 'api'" x-cloak>
        <div class="space-y-6">
          <!-- Status & Health -->
          <div class="card rounded-xl overflow-hidden">
            <div class="px-4 py-3 border-b border-white/5 flex items-center gap-2">
              <div class="w-6 h-6 rounded-lg bg-apple-green/15 flex items-center justify-center">
                <svg class="w-3.5 h-3.5 text-apple-green" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
              </div>
              <h3 class="font-medium text-sm">Status & Health</h3>
            </div>
            <div class="divide-y divide-white/5">
              <div class="p-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-2 py-0.5 rounded text-[10px] font-semibold bg-apple-green/20 text-apple-green">GET</span>
                  <code class="mono text-sm text-apple-cyan">/health</code>
                </div>
                <p class="text-xs text-apple-secondary mb-2">Basic health check endpoint.</p>
                <div class="text-xs text-apple-tertiary">Returns: <code class="mono text-apple-yellow">{"status": "ok"}</code></div>
              </div>
              <div class="p-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-2 py-0.5 rounded text-[10px] font-semibold bg-apple-green/20 text-apple-green">GET</span>
                  <code class="mono text-sm text-apple-cyan">/api/status</code>
                </div>
                <p class="text-xs text-apple-secondary mb-2">Server status with working directory info.</p>
                <div class="text-xs text-apple-tertiary">Returns: <code class="mono text-apple-yellow">{"status", "working_directory"}</code></div>
              </div>
              <div class="p-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-2 py-0.5 rounded text-[10px] font-semibold bg-apple-green/20 text-apple-green">GET</span>
                  <code class="mono text-sm text-apple-cyan">/api/local-claude/check</code>
                </div>
                <p class="text-xs text-apple-secondary mb-2">Check if Claude CLI is installed.</p>
                <div class="text-xs text-apple-tertiary">Returns: <code class="mono text-apple-yellow">{"installed", "path", "version"}</code></div>
              </div>
            </div>
          </div>

          <!-- Agents -->
          <div class="card rounded-xl overflow-hidden">
            <div class="px-4 py-3 border-b border-white/5 flex items-center gap-2">
              <div class="w-6 h-6 rounded-lg bg-apple-blue/15 flex items-center justify-center">
                <svg class="w-3.5 h-3.5 text-apple-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                </svg>
              </div>
              <h3 class="font-medium text-sm">Agents</h3>
            </div>
            <div class="divide-y divide-white/5">
              <div class="p-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-2 py-0.5 rounded text-[10px] font-semibold bg-apple-orange/20 text-apple-orange">POST</span>
                  <code class="mono text-sm text-apple-cyan">/api/local-claude/agents</code>
                </div>
                <p class="text-xs text-apple-secondary mb-2">Start a new Claude agent.</p>
                <div class="text-xs text-apple-tertiary mb-1">Body: <code class="mono text-apple-yellow">{"task_number", "task_title", "task_description", "model?"}</code></div>
                <div class="text-xs text-apple-tertiary">Returns: <code class="mono text-apple-yellow">{"id", "status", "branch", "worktree_path"}</code></div>
              </div>
              <div class="p-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-2 py-0.5 rounded text-[10px] font-semibold bg-apple-green/20 text-apple-green">GET</span>
                  <code class="mono text-sm text-apple-cyan">/api/local-claude/agents</code>
                </div>
                <p class="text-xs text-apple-secondary mb-2">List all running agents.</p>
                <div class="text-xs text-apple-tertiary">Returns: Array of agent objects</div>
              </div>
              <div class="p-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-2 py-0.5 rounded text-[10px] font-semibold bg-apple-green/20 text-apple-green">GET</span>
                  <code class="mono text-sm text-apple-cyan">/api/local-claude/agents/{`{id}`}</code>
                </div>
                <p class="text-xs text-apple-secondary mb-2">Get details of a specific agent.</p>
                <div class="text-xs text-apple-tertiary">Returns: Agent object with status, branch, worktree, etc.</div>
              </div>
              <div class="p-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-2 py-0.5 rounded text-[10px] font-semibold bg-apple-red/20 text-apple-red">DELETE</span>
                  <code class="mono text-sm text-apple-cyan">/api/local-claude/agents/{`{id}`}</code>
                </div>
                <p class="text-xs text-apple-secondary mb-2">Kill a running agent.</p>
                <div class="text-xs text-apple-tertiary">Returns: <code class="mono text-apple-yellow">{"status": "killed"}</code></div>
              </div>
              <div class="p-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-2 py-0.5 rounded text-[10px] font-semibold bg-apple-orange/20 text-apple-orange">POST</span>
                  <code class="mono text-sm text-apple-cyan">/api/local-claude/agents/{`{id}`}/input</code>
                </div>
                <p class="text-xs text-apple-secondary mb-2">Send follow-up input to a paused agent.</p>
                <div class="text-xs text-apple-tertiary">Body: <code class="mono text-apple-yellow">{"input": "your message"}</code></div>
              </div>
              <div class="p-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-2 py-0.5 rounded text-[10px] font-semibold bg-apple-green/20 text-apple-green">GET</span>
                  <code class="mono text-sm text-apple-cyan">/api/local-claude/agents/{`{id}`}/output</code>
                </div>
                <p class="text-xs text-apple-secondary mb-2">Get accumulated output from an agent.</p>
                <div class="text-xs text-apple-tertiary">Query: <code class="mono text-apple-yellow">?offset=0</code> (optional)</div>
              </div>
              <div class="p-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-2 py-0.5 rounded text-[10px] font-semibold bg-apple-purple/20 text-apple-purple">SSE</span>
                  <code class="mono text-sm text-apple-cyan">/api/local-claude/agents/{`{id}`}/stream</code>
                </div>
                <p class="text-xs text-apple-secondary mb-2">Server-Sent Events stream for real-time output.</p>
                <div class="text-xs text-apple-tertiary">Events: <code class="mono text-apple-yellow">output</code>, <code class="mono text-apple-yellow">exit</code>, <code class="mono text-apple-yellow">paused</code></div>
              </div>
            </div>
          </div>

          <!-- Worktrees -->
          <div class="card rounded-xl overflow-hidden">
            <div class="px-4 py-3 border-b border-white/5 flex items-center gap-2">
              <div class="w-6 h-6 rounded-lg bg-apple-cyan/15 flex items-center justify-center">
                <svg class="w-3.5 h-3.5 text-apple-cyan" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                </svg>
              </div>
              <h3 class="font-medium text-sm">Worktrees</h3>
            </div>
            <div class="divide-y divide-white/5">
              <div class="p-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-2 py-0.5 rounded text-[10px] font-semibold bg-apple-green/20 text-apple-green">GET</span>
                  <code class="mono text-sm text-apple-cyan">/api/local-claude/worktrees</code>
                </div>
                <p class="text-xs text-apple-secondary mb-2">List all git worktrees with status info.</p>
                <div class="text-xs text-apple-tertiary">Returns: <code class="mono text-apple-yellow">{"worktrees": [{branch, path, has_changes, merged_to_main, last_commit}]}</code></div>
              </div>
              <div class="p-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-2 py-0.5 rounded text-[10px] font-semibold bg-apple-red/20 text-apple-red">DELETE</span>
                  <code class="mono text-sm text-apple-cyan">/api/local-claude/worktree</code>
                </div>
                <p class="text-xs text-apple-secondary mb-2">Delete a worktree and optionally its branch.</p>
                <div class="text-xs text-apple-tertiary">Query: <code class="mono text-apple-yellow">?task_number=42&worktree_path=/path</code></div>
              </div>
            </div>
          </div>

          <!-- Git Operations -->
          <div class="card rounded-xl overflow-hidden">
            <div class="px-4 py-3 border-b border-white/5 flex items-center gap-2">
              <div class="w-6 h-6 rounded-lg bg-apple-purple/15 flex items-center justify-center">
                <svg class="w-3.5 h-3.5 text-apple-purple" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
              </div>
              <h3 class="font-medium text-sm">Git Operations</h3>
            </div>
            <div class="divide-y divide-white/5">
              <div class="p-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-2 py-0.5 rounded text-[10px] font-semibold bg-apple-green/20 text-apple-green">GET</span>
                  <code class="mono text-sm text-apple-cyan">/api/local-claude/commits</code>
                </div>
                <p class="text-xs text-apple-secondary mb-2">Get commit history.</p>
                <div class="text-xs text-apple-tertiary">Query: <code class="mono text-apple-yellow">?limit=20&all_branches=false&task_number=?</code></div>
              </div>
              <div class="p-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-2 py-0.5 rounded text-[10px] font-semibold bg-apple-green/20 text-apple-green">GET</span>
                  <code class="mono text-sm text-apple-cyan">/api/local-claude/commit-diff/{`{sha}`}</code>
                </div>
                <p class="text-xs text-apple-secondary mb-2">Get diff for a specific commit.</p>
                <div class="text-xs text-apple-tertiary">Returns: <code class="mono text-apple-yellow">{"sha", "message", "diff", "files"}</code></div>
              </div>
              <div class="p-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-2 py-0.5 rounded text-[10px] font-semibold bg-apple-green/20 text-apple-green">GET</span>
                  <code class="mono text-sm text-apple-cyan">/api/local-claude/diff</code>
                </div>
                <p class="text-xs text-apple-secondary mb-2">Get uncommitted changes in a worktree.</p>
                <div class="text-xs text-apple-tertiary">Query: <code class="mono text-apple-yellow">?task_number=42</code></div>
              </div>
              <div class="p-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-2 py-0.5 rounded text-[10px] font-semibold bg-apple-green/20 text-apple-green">GET</span>
                  <code class="mono text-sm text-apple-cyan">/api/local-claude/merge-preview</code>
                </div>
                <p class="text-xs text-apple-secondary mb-2">Preview merge conflicts before merging.</p>
                <div class="text-xs text-apple-tertiary">Query: <code class="mono text-apple-yellow">?task_number=42&branch=feature</code></div>
              </div>
              <div class="p-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-2 py-0.5 rounded text-[10px] font-semibold bg-apple-orange/20 text-apple-orange">POST</span>
                  <code class="mono text-sm text-apple-cyan">/api/local-claude/merge</code>
                </div>
                <p class="text-xs text-apple-secondary mb-2">Merge a branch into main.</p>
                <div class="text-xs text-apple-tertiary">Body: <code class="mono text-apple-yellow">{"task_number", "branch"}</code></div>
              </div>
              <div class="p-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-2 py-0.5 rounded text-[10px] font-semibold bg-apple-orange/20 text-apple-orange">POST</span>
                  <code class="mono text-sm text-apple-cyan">/api/local-claude/open-in-editor</code>
                </div>
                <p class="text-xs text-apple-secondary mb-2">Open worktree in VS Code / Cursor.</p>
                <div class="text-xs text-apple-tertiary">Body: <code class="mono text-apple-yellow">{"task_number"}</code></div>
              </div>
            </div>
          </div>

          <!-- Dev Servers -->
          <div class="card rounded-xl overflow-hidden">
            <div class="px-4 py-3 border-b border-white/5 flex items-center gap-2">
              <div class="w-6 h-6 rounded-lg bg-apple-orange/15 flex items-center justify-center">
                <svg class="w-3.5 h-3.5 text-apple-orange" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2"/>
                </svg>
              </div>
              <h3 class="font-medium text-sm">Dev Servers</h3>
            </div>
            <div class="divide-y divide-white/5">
              <div class="p-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-2 py-0.5 rounded text-[10px] font-semibold bg-apple-green/20 text-apple-green">GET</span>
                  <code class="mono text-sm text-apple-cyan">/api/local-claude/dev-server</code>
                </div>
                <p class="text-xs text-apple-secondary mb-2">List running dev servers and proxy status.</p>
                <div class="text-xs text-apple-tertiary">Returns: <code class="mono text-apple-yellow">{"servers": [], "proxy": {running, proxyPort, targetPort}}</code></div>
              </div>
              <div class="p-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-2 py-0.5 rounded text-[10px] font-semibold bg-apple-orange/20 text-apple-orange">POST</span>
                  <code class="mono text-sm text-apple-cyan">/api/local-claude/dev-server</code>
                </div>
                <p class="text-xs text-apple-secondary mb-2">Start a dev server in a worktree.</p>
                <div class="text-xs text-apple-tertiary">Body: <code class="mono text-apple-yellow">{"task_number", "command?"}</code></div>
              </div>
              <div class="p-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-2 py-0.5 rounded text-[10px] font-semibold bg-apple-red/20 text-apple-red">DELETE</span>
                  <code class="mono text-sm text-apple-cyan">/api/local-claude/dev-server</code>
                </div>
                <p class="text-xs text-apple-secondary mb-2">Stop a running dev server.</p>
                <div class="text-xs text-apple-tertiary">Query: <code class="mono text-apple-yellow">?run_id=abc123</code></div>
              </div>
              <div class="p-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-2 py-0.5 rounded text-[10px] font-semibold bg-apple-green/20 text-apple-green">GET</span>
                  <code class="mono text-sm text-apple-cyan">/api/local-claude/dev-proxy</code>
                </div>
                <p class="text-xs text-apple-secondary mb-2">Get dev proxy status.</p>
                <div class="text-xs text-apple-tertiary">Returns: <code class="mono text-apple-yellow">{"running", "proxyPort", "proxyUrl", "targetPort", "targetRunId"}</code></div>
              </div>
              <div class="p-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-2 py-0.5 rounded text-[10px] font-semibold bg-apple-orange/20 text-apple-orange">POST</span>
                  <code class="mono text-sm text-apple-cyan">/api/local-claude/dev-proxy</code>
                </div>
                <p class="text-xs text-apple-secondary mb-2">Set the dev proxy target to a specific server.</p>
                <div class="text-xs text-apple-tertiary">Query: <code class="mono text-apple-yellow">?run_id=abc123</code></div>
              </div>
            </div>
          </div>

          <!-- Time Machine -->
          <div class="card rounded-xl overflow-hidden">
            <div class="px-4 py-3 border-b border-white/5 flex items-center gap-2">
              <div class="w-6 h-6 rounded-lg bg-apple-pink/15 flex items-center justify-center">
                <svg class="w-3.5 h-3.5 text-apple-pink" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
              </div>
              <h3 class="font-medium text-sm">Time Machine</h3>
            </div>
            <div class="divide-y divide-white/5">
              <div class="p-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-2 py-0.5 rounded text-[10px] font-semibold bg-apple-green/20 text-apple-green">GET</span>
                  <code class="mono text-sm text-apple-cyan">/api/local-claude/time-machine/previews</code>
                </div>
                <p class="text-xs text-apple-secondary mb-2">List active commit previews.</p>
                <div class="text-xs text-apple-tertiary">Returns: <code class="mono text-apple-yellow">{"previews": [{sha, url, port}]}</code></div>
              </div>
              <div class="p-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-2 py-0.5 rounded text-[10px] font-semibold bg-apple-orange/20 text-apple-orange">POST</span>
                  <code class="mono text-sm text-apple-cyan">/api/local-claude/time-machine/preview</code>
                </div>
                <p class="text-xs text-apple-secondary mb-2">Start a preview server at a specific commit.</p>
                <div class="text-xs text-apple-tertiary">Body: <code class="mono text-apple-yellow">{"commit_sha"}</code></div>
              </div>
              <div class="p-4">
                <div class="flex items-center gap-2 mb-2">
                  <span class="px-2 py-0.5 rounded text-[10px] font-semibold bg-apple-red/20 text-apple-red">DELETE</span>
                  <code class="mono text-sm text-apple-cyan">/api/local-claude/time-machine/preview/{`{sha}`}</code>
                </div>
                <p class="text-xs text-apple-secondary mb-2">Stop a commit preview server.</p>
                <div class="text-xs text-apple-tertiary">Returns: <code class="mono text-apple-yellow">{"status": "stopped"}</code></div>
              </div>
            </div>
          </div>

          <!-- Relay Architecture -->
          <div class="card rounded-xl overflow-hidden">
            <div class="px-4 py-3 border-b border-white/5 flex items-center gap-2">
              <div class="w-6 h-6 rounded-lg bg-apple-yellow/15 flex items-center justify-center">
                <svg class="w-3.5 h-3.5 text-apple-yellow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                </svg>
              </div>
              <h3 class="font-medium text-sm">Relay Architecture</h3>
            </div>
            <div class="p-4 space-y-4">
              <p class="text-xs text-apple-secondary">The relay system bridges your local machine to Branch Monkey Cloud, enabling remote control via the web UI.</p>

              <div class="bg-black/30 rounded-xl p-4 space-y-3">
                <div class="flex items-center gap-3">
                  <div class="w-24 text-center">
                    <div class="bg-apple-blue/20 text-apple-blue text-[10px] font-medium px-2 py-1 rounded-lg">Cloud UI</div>
                    <div class="text-[10px] text-apple-tertiary mt-1" x-text="appDomain || 'cloud'"></div>
                  </div>
                  <div class="flex-1 border-t border-dashed border-apple-yellow/50 relative">
                    <span class="absolute -top-2.5 left-1/2 -translate-x-1/2 text-[10px] text-apple-yellow bg-black/50 px-2">Supabase Realtime</span>
                  </div>
                  <div class="w-24 text-center">
                    <div class="bg-apple-green/20 text-apple-green text-[10px] font-medium px-2 py-1 rounded-lg">Relay Client</div>
                    <div class="text-[10px] text-apple-tertiary mt-1">branch-monkey-relay</div>
                  </div>
                  <div class="flex-1 border-t border-apple-cyan/50 relative">
                    <span class="absolute -top-2.5 left-1/2 -translate-x-1/2 text-[10px] text-apple-cyan bg-black/50 px-2">HTTP</span>
                  </div>
                  <div class="w-24 text-center">
                    <div class="bg-apple-purple/20 text-apple-purple text-[10px] font-medium px-2 py-1 rounded-lg">Local Server</div>
                    <div class="text-[10px] text-apple-tertiary mt-1">localhost:18081</div>
                  </div>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs">
                <div class="bg-black/20 rounded-lg p-3">
                  <div class="font-medium text-apple-green mb-2">Start Relay</div>
                  <code class="mono text-[11px] text-apple-secondary">branch-monkey-relay --dir /path/to/project</code>
                </div>
                <div class="bg-black/20 rounded-lg p-3">
                  <div class="font-medium text-apple-cyan mb-2">Relay Options</div>
                  <div class="mono text-[11px] text-apple-secondary space-y-1">
                    <div>--port 18081 <span class="text-apple-tertiary"># Local server port</span></div>
                    <div>--no-server <span class="text-apple-tertiary"># Use existing server</span></div>
                    <div>--no-mcp <span class="text-apple-tertiary"># Skip MCP config setup</span></div>
                  </div>
                </div>
              </div>

              <div class="text-xs text-apple-tertiary">
                <span class="text-apple-yellow">Note:</span> The relay authenticates via device code flow on first run. Token is cached at <code class="mono">~/.branch-monkey/relay_token.json</code>
              </div>
            </div>
          </div>

          <!-- MCP Tools -->
          <div class="card rounded-xl overflow-hidden">
            <div class="px-4 py-3 border-b border-white/5 flex items-center gap-2">
              <div class="w-6 h-6 rounded-lg bg-gradient-to-br from-apple-blue to-apple-purple flex items-center justify-center">
                <svg class="w-3.5 h-3.5 text-white" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
              </div>
              <h3 class="font-medium text-sm">MCP Tools (Claude Code)</h3>
            </div>
            <div class="p-4 space-y-4">
              <p class="text-xs text-apple-secondary">These tools are available when using Branch Monkey as an MCP server in Claude Code.</p>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs">
                <div class="bg-black/20 rounded-lg p-3">
                  <div class="font-medium text-apple-blue mb-2">Authentication</div>
                  <div class="space-y-1 mono text-[11px]">
                    <div><span class="text-apple-cyan">monkey_status</span> <span class="text-apple-tertiary">- Connection status</span></div>
                    <div><span class="text-apple-cyan">monkey_login</span> <span class="text-apple-tertiary">- Re-authenticate</span></div>
                    <div><span class="text-apple-cyan">monkey_logout</span> <span class="text-apple-tertiary">- Clear token</span></div>
                  </div>
                </div>
                <div class="bg-black/20 rounded-lg p-3">
                  <div class="font-medium text-apple-green mb-2">Projects</div>
                  <div class="space-y-1 mono text-[11px]">
                    <div><span class="text-apple-cyan">monkey_project_list</span> <span class="text-apple-tertiary">- List projects</span></div>
                    <div><span class="text-apple-cyan">monkey_project_focus</span> <span class="text-apple-tertiary">- Set active project</span></div>
                    <div><span class="text-apple-cyan">monkey_org_list</span> <span class="text-apple-tertiary">- List organizations</span></div>
                  </div>
                </div>
                <div class="bg-black/20 rounded-lg p-3">
                  <div class="font-medium text-apple-orange mb-2">Tasks</div>
                  <div class="space-y-1 mono text-[11px]">
                    <div><span class="text-apple-cyan">monkey_task_list</span> <span class="text-apple-tertiary">- List tasks</span></div>
                    <div><span class="text-apple-cyan">monkey_task_create</span> <span class="text-apple-tertiary">- Create task</span></div>
                    <div><span class="text-apple-cyan">monkey_task_work</span> <span class="text-apple-tertiary">- Start working</span></div>
                    <div><span class="text-apple-cyan">monkey_task_log</span> <span class="text-apple-tertiary">- Log progress</span></div>
                    <div><span class="text-apple-cyan">monkey_task_complete</span> <span class="text-apple-tertiary">- Complete + PR</span></div>
                    <div><span class="text-apple-cyan">monkey_task_search</span> <span class="text-apple-tertiary">- Search tasks</span></div>
                  </div>
                </div>
                <div class="bg-black/20 rounded-lg p-3">
                  <div class="font-medium text-apple-purple mb-2">Contexts</div>
                  <div class="space-y-1 mono text-[11px]">
                    <div><span class="text-apple-cyan">monkey_context_list</span> <span class="text-apple-tertiary">- List contexts</span></div>
                    <div><span class="text-apple-cyan">monkey_context_create</span> <span class="text-apple-tertiary">- Create context</span></div>
                    <div><span class="text-apple-cyan">monkey_task_link_context</span> <span class="text-apple-tertiary">- Link to task</span></div>
                    <div><span class="text-apple-cyan">monkey_context_search</span> <span class="text-apple-tertiary">- Search contexts</span></div>
                  </div>
                </div>
                <div class="bg-black/20 rounded-lg p-3">
                  <div class="font-medium text-apple-pink mb-2">Resources</div>
                  <div class="space-y-1 mono text-[11px]">
                    <div><span class="text-apple-cyan">monkey_machine_list</span> <span class="text-apple-tertiary">- List machines</span></div>
                    <div><span class="text-apple-cyan">monkey_version_list</span> <span class="text-apple-tertiary">- List versions</span></div>
                    <div><span class="text-apple-cyan">monkey_team_list</span> <span class="text-apple-tertiary">- List team members</span></div>
                    <div><span class="text-apple-cyan">monkey_domain_list</span> <span class="text-apple-tertiary">- List domains</span></div>
                    <div><span class="text-apple-cyan">monkey_note_list</span> <span class="text-apple-tertiary">- List notes</span></div>
                  </div>
                </div>
                <div class="bg-black/20 rounded-lg p-3">
                  <div class="font-medium text-apple-yellow mb-2">MCP Setup</div>
                  <div class="mono text-[10px] text-apple-secondary bg-black/30 rounded p-2 mt-1">
                    <div class="text-apple-tertiary mb-1">// .mcp.json</div>
                    <div>"branch-monkey-cloud": {</div>
                    <div class="pl-2">"command": "uvx",</div>
                    <div class="pl-2">"args": ["--from", "git+..."]</div>
                    <div>}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Quick Reference -->
          <div class="card rounded-xl p-4">
            <h3 class="font-medium text-sm mb-3">Quick Reference</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-xs">
              <div>
                <div class="text-apple-secondary mb-1">Local Server</div>
                <code class="mono text-apple-cyan">http://localhost:18081</code>
              </div>
              <div>
                <div class="text-apple-secondary mb-1">Cloud API</div>
                <code class="mono text-apple-blue" x-text="appDomain || 'cloud'"></code>
              </div>
              <div>
                <div class="text-apple-secondary mb-1">Content-Type</div>
                <code class="mono text-apple-yellow">application/json</code>
              </div>
              <div>
                <div class="text-apple-secondary mb-1">Error Format</div>
                <code class="mono text-apple-red">{"detail": "..."}</code>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Diff Modal -->
    <div x-show="showDiffModal" x-cloak @click.self="showDiffModal = false"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-6">
      <div x-show="showDiffModal"
           x-transition:enter="transition ease-out duration-200"
           x-transition:enter-start="opacity-0 scale-95"
           x-transition:enter-end="opacity-100 scale-100"
           class="surface rounded-2xl max-w-4xl w-full max-h-[80vh] overflow-hidden flex flex-col border border-white/10">
        <div class="px-5 py-4 border-b border-white/5 flex items-center justify-between">
          <div>
            <h3 class="font-semibold" x-text="commitDiff?.message"></h3>
            <span class="mono text-xs text-apple-yellow" x-text="commitDiff?.sha"></span>
          </div>
          <button @click="showDiffModal = false" class="p-1.5 hover:bg-white/5 rounded-lg transition-colors">
            <svg class="w-5 h-5 text-apple-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        <div class="p-5 overflow-auto flex-1">
          <div x-show="commitDiff?.files?.length > 0" class="mb-4 flex flex-wrap gap-2">
            <template x-for="file in commitDiff?.files || []" :key="file.path">
              <span class="mono text-xs bg-black/30 px-2 py-1 rounded-lg border border-white/5">
                <span class="text-apple-secondary" x-text="file.path"></span>
                <span class="text-apple-green ml-1" x-text="'+' + file.insertions"></span>
                <span class="text-apple-red ml-1" x-text="'-' + file.deletions"></span>
              </span>
            </template>
          </div>
          <pre class="mono text-xs bg-black/40 p-4 rounded-xl overflow-auto leading-relaxed" x-html="formatDiff(commitDiff?.diff || '')"></pre>
        </div>
      </div>
    </div>

    <!-- Directory Modal -->
    <div x-show="showDirectoryModal" x-cloak @click.self="showDirectoryModal = false"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-6">
      <div x-show="showDirectoryModal"
           x-transition:enter="transition ease-out duration-200"
           x-transition:enter-start="opacity-0 scale-95"
           x-transition:enter-end="opacity-100 scale-100"
           class="surface rounded-2xl max-w-2xl w-full overflow-hidden flex flex-col border border-white/10 max-h-[80vh]">
        <div class="px-5 py-4 border-b border-white/5 flex items-center justify-between">
          <div>
            <h3 class="font-semibold" x-text="directoryModalMode === 'home' ? 'Change Home Directory' : 'Select Project'"></h3>
            <span class="text-xs text-apple-secondary" x-text="directoryModalMode === 'home' ? 'Base directory where your projects live' : 'Choose a project to work on'"></span>
          </div>
          <button @click="showDirectoryModal = false; directoryError = null" class="p-1.5 hover:bg-white/5 rounded-lg transition-colors">
            <svg class="w-5 h-5 text-apple-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        <div class="p-5 overflow-y-auto">
          <!-- Home directory mode: show info about restarting -->
          <div x-show="directoryModalMode === 'home'" class="mb-4 bg-apple-purple/10 border border-apple-purple/20 rounded-lg px-4 py-3">
            <p class="text-sm text-apple-purple mb-2">To change the home directory, restart the relay with:</p>
            <code class="text-xs mono text-apple-cyan bg-black/30 px-2 py-1 rounded">branch-monkey-relay --dir /new/path</code>
          </div>

          <!-- Manual path input (project mode only) -->
          <div x-show="directoryModalMode === 'project'" class="mb-4">
            <label class="text-xs text-apple-secondary block mb-2">Or enter path manually</label>
            <div class="flex gap-2">
              <input type="text"
                     x-model="newDirectoryPath"
                     @keydown.enter="setWorkingDirectory()"
                     placeholder="/path/to/project"
                     class="flex-1 bg-black/30 border border-white/10 rounded-xl px-4 py-2.5 text-sm mono focus:border-apple-blue/50 placeholder-apple-tertiary">
              <button @click="setWorkingDirectory()" class="btn btn-primary px-4 py-2.5 rounded-xl text-sm">
                Set
              </button>
            </div>
          </div>

          <!-- Discovered projects list (only for project mode) -->
          <div x-show="directoryModalMode === 'project'" class="mb-4">
            <div class="flex items-center justify-between mb-2">
              <label class="text-xs text-apple-secondary">Discovered Projects</label>
              <button @click="refreshDiscoveredProjects()" class="text-xs text-apple-cyan hover:underline flex items-center gap-1">
                <svg class="w-3 h-3" :class="loadingProjects ? 'animate-spin' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Refresh
              </button>
            </div>
            <div x-show="loadingProjects" class="text-center py-8 text-apple-secondary text-sm">
              Loading projects...
            </div>
            <div x-show="!loadingProjects && discoveredProjects.length === 0" class="text-center py-8 text-apple-tertiary text-sm">
              No projects found. Click Refresh to scan.
            </div>
            <div x-show="!loadingProjects && discoveredProjects.length > 0" class="grid grid-cols-2 gap-2 max-h-[300px] overflow-y-auto">
              <template x-for="project in discoveredProjects" :key="project.path">
                <button @click="selectProject(project.path)"
                        class="flex items-center gap-2 bg-black/30 hover:bg-apple-yellow/10 rounded-lg px-3 py-2.5 text-left transition-colors border border-transparent hover:border-apple-yellow/30"
                        :class="workingDirectory === project.path ? 'border-apple-green/50 bg-apple-green/10' : ''">
                  <svg class="w-4 h-4 text-apple-yellow flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                  </svg>
                  <div class="min-w-0 flex-1">
                    <div class="text-xs font-medium truncate" x-text="project.name"></div>
                    <div class="text-[10px] text-apple-tertiary truncate" x-text="project.parent"></div>
                  </div>
                  <svg x-show="workingDirectory === project.path" class="w-4 h-4 text-apple-green flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>
                </button>
              </template>
            </div>
          </div>

          <div x-show="directoryError" class="mb-4 bg-apple-red/10 border border-apple-red/20 rounded-lg px-4 py-3">
            <p class="text-sm text-apple-red" x-text="directoryError"></p>
          </div>

          <div class="flex gap-3 justify-end pt-2 border-t border-white/5">
            <button @click="showDirectoryModal = false; directoryError = null" class="btn btn-secondary px-4 py-2 rounded-xl text-sm">
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function dashboard() {
      return {
        // Configurable app name (fetched from cloud)
        appName: 'Branch Monkey',
        appDomain: null,
        cloudUrl: null,

        connected: false,
        claudeInstalled: false,
        activeTab: 'relay',
        agents: [],
        agentOutput: {},
        inputMessages: {},
        agentStreams: {},
        worktrees: [],
        devServers: [],
        proxyStatus: { running: false, proxyPort: 5176, targetPort: null, targetRunId: null },
        commits: [],
        currentBranch: '',
        showAllBranches: false,
        selectedCommit: null,
        commitDiff: null,
        showDiffModal: false,
        previews: [],
        cloudReachable: null,
        relayConnected: false,
        relayInfo: null,
        workingDirectory: '',
        workingDirInfo: null,
        showDirectoryModal: false,
        directoryModalMode: 'project', // 'home' or 'project'
        newDirectoryPath: '',
        directoryError: null,
        discoveredProjects: [],
        loadingProjects: false,

        get hasProjectSelected() {
          // Project is selected if working_directory differs from home_directory and is a git repo
          const home = this.workingDirInfo?.home_directory;
          const working = this.workingDirectory;
          return home && working && home !== working && this.workingDirInfo?.is_git_repo;
        },

        async init() {
          await this.fetchAppConfig();
          document.title = this.appName;
          await this.refreshAll();
          this.checkRelayStatus();
          this.refreshWorkingDirectory();
          this.refreshDiscoveredProjects();
          setInterval(() => this.refreshAll(), 5000);
          setInterval(() => this.checkRelayStatus(), 10000);
        },

        async fetchAppConfig() {
          // Fetch app config from local server (proxied from cloud)
          try {
            // Also get cloud URL for display
            const relayRes = await fetch('/api/relay/status');
            const relayData = await relayRes.json();
            this.cloudUrl = relayData.cloud_url || 'https://p-63-branch-monkey.pages.dev';

            // Fetch config from local server (avoids CORS issues)
            const res = await fetch('/api/config');
            if (res.ok) {
              const data = await res.json();
              if (data.appNameDisplay || data.appNameTitle || data.appName) {
                this.appName = data.appNameDisplay || data.appNameTitle || data.appName;
              }
              if (data.appDomain) {
                this.appDomain = data.appDomain;
              }
            }
          } catch (e) {
            // Keep default 'Branch Monkey'
          }
        },

        async refreshAll() {
          await Promise.all([
            this.refreshStatus(),
            this.refreshAgents(),
            this.refreshWorktrees(),
            this.refreshDevServers(),
            this.refreshCommits(),
            this.refreshPreviews(),
            this.refreshWorkingDirectory()
          ]);
        },

        async refreshWorkingDirectory() {
          try {
            const res = await fetch('/api/config/working-directory');
            const data = await res.json();
            this.workingDirectory = data.working_directory;
            this.workingDirInfo = data;
          } catch (e) {
            this.workingDirectory = '';
            this.workingDirInfo = null;
          }
        },

        async setWorkingDirectory() {
          if (!this.newDirectoryPath.trim()) {
            this.directoryError = 'Please enter a directory path';
            return;
          }
          this.directoryError = null;
          try {
            const res = await fetch('/api/config/working-directory', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ directory: this.newDirectoryPath.trim() })
            });
            const data = await res.json();
            if (!res.ok) {
              this.directoryError = data.detail || 'Failed to set directory';
              return;
            }
            this.workingDirectory = data.working_directory;
            this.workingDirInfo = data;
            this.showDirectoryModal = false;
            this.newDirectoryPath = '';
            // Refresh worktrees with new directory
            await this.refreshWorktrees();
          } catch (e) {
            this.directoryError = 'Failed to set directory: ' + e.message;
          }
        },

        async refreshDiscoveredProjects() {
          this.loadingProjects = true;
          try {
            const res = await fetch('/api/local-claude/projects');
            const data = await res.json();
            this.discoveredProjects = data.projects || [];
          } catch (e) {
            this.discoveredProjects = [];
          } finally {
            this.loadingProjects = false;
          }
        },

        async selectProject(path) {
          try {
            const res = await fetch('/api/config/working-directory', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ directory: path })
            });
            const data = await res.json();
            if (res.ok) {
              this.workingDirectory = data.working_directory;
              this.workingDirInfo = data;
              this.showDirectoryModal = false;
              await this.refreshWorktrees();
            }
          } catch (e) {
            console.error('Failed to select project:', e);
          }
        },

        openDirectoryModal(mode) {
          this.directoryModalMode = mode;
          this.directoryError = null;
          if (mode === 'home') {
            this.newDirectoryPath = this.workingDirInfo?.home_directory || '';
          } else {
            this.newDirectoryPath = this.workingDirectory || '';
          }
          this.showDirectoryModal = true;
          // Refresh projects list when opening modal
          if (this.discoveredProjects.length === 0) {
            this.refreshDiscoveredProjects();
          }
        },

        async clearProject() {
          // Reset working directory to home directory
          const homeDir = this.workingDirInfo?.home_directory;
          if (!homeDir) return;
          try {
            const res = await fetch('/api/config/working-directory', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ directory: homeDir })
            });
            const data = await res.json();
            if (res.ok) {
              this.workingDirectory = data.working_directory;
              this.workingDirInfo = data;
              await this.refreshWorktrees();
            }
          } catch (e) {
            console.error('Failed to clear project:', e);
          }
        },

        async checkCloudStatus() {
          try {
            this.cloudReachable = null;
            const cloudUrl = this.cloudUrl || 'https://p-63-branch-monkey.pages.dev';
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000);
            const res = await fetch(`${cloudUrl}/api/health`, {
              method: 'GET',
              mode: 'cors',
              signal: controller.signal
            });
            clearTimeout(timeoutId);
            this.cloudReachable = res.ok;
          } catch (e) {
            this.cloudReachable = false;
          }
        },

        async checkRelayStatus() {
          try {
            const res = await fetch('/api/relay/status');
            const data = await res.json();
            this.relayConnected = data.connected || false;
            this.relayInfo = data;
          } catch (e) {
            this.relayConnected = false;
            this.relayInfo = null;
          }
        },

        async refreshRelayStatus() {
          await this.checkRelayStatus();
        },

        async disconnectRelay() {
          if (!confirm('Disconnect relay from cloud? You will need to restart the relay process to reconnect.')) return;
          try {
            await fetch('/api/relay/disconnect', { method: 'POST' });
            await this.checkRelayStatus();
          } catch (e) {
            console.error('Failed to disconnect relay:', e);
          }
        },

        async refreshStatus() {
          try {
            const [statusRes, claudeRes] = await Promise.all([
              fetch('/api/status'),
              fetch('/api/local-claude/check')
            ]);
            await statusRes.json();
            const claude = await claudeRes.json();
            this.connected = true;
            this.claudeInstalled = claude.installed;
          } catch (e) {
            this.connected = false;
          }
        },

        async refreshAgents() {
          try {
            const res = await fetch('/api/local-claude/agents');
            this.agents = await res.json();
            for (const agent of this.agents) {
              if (agent.status === 'running' && !this.agentStreams[agent.id]) {
                this.subscribeToAgent(agent.id);
              }
            }
          } catch (e) {}
        },

        subscribeToAgent(agentId) {
          if (this.agentStreams[agentId]) return;
          const es = new EventSource(`/api/local-claude/agents/${agentId}/stream`);
          this.agentStreams[agentId] = es;
          this.agentOutput[agentId] = this.agentOutput[agentId] || [];

          es.onmessage = (e) => {
            try {
              const data = JSON.parse(e.data);
              if (data.type === 'output') {
                this.agentOutput[agentId].push(data);
                if (this.agentOutput[agentId].length > 500) {
                  this.agentOutput[agentId] = this.agentOutput[agentId].slice(-500);
                }
                this.$nextTick(() => {
                  const el = document.getElementById(`output-${agentId}`);
                  if (el) el.scrollTop = el.scrollHeight;
                });
              } else if (data.type === 'exit' || data.type === 'paused') {
                this.refreshAgents();
                es.close();
                delete this.agentStreams[agentId];
              }
            } catch (e) {}
          };
          es.onerror = () => { es.close(); delete this.agentStreams[agentId]; };
        },

        formatOutput(output) {
          if (!output || output.length === 0) return '<span class="text-apple-tertiary">Waiting for output...</span>';
          return output.map(item => {
            if (!item.data) return '';
            try {
              const p = JSON.parse(item.data);
              if (p.type === 'assistant' && p.message?.content) {
                const c = p.message.content;
                if (Array.isArray(c)) {
                  return c.map(x => {
                    if (x.type === 'text') return `<div class="text-white/90 mb-2">${this.esc(x.text)}</div>`;
                    if (x.type === 'tool_use') return `<div class="text-apple-blue mb-1">→ ${x.name}</div>`;
                    return '';
                  }).join('');
                }
              }
              if (p.type === 'result' && p.result) return `<div class="text-apple-green mb-2">✓ ${this.esc(p.result)}</div>`;
              if (p.type === 'system') return `<div class="text-apple-tertiary text-[10px]">[${p.subtype || 'system'}]</div>`;
              return `<div class="text-apple-tertiary">${this.esc(item.data.substring(0, 150))}${item.data.length > 150 ? '...' : ''}</div>`;
            } catch (e) {
              return `<div class="text-apple-secondary">${this.esc(item.data)}</div>`;
            }
          }).join('');
        },

        esc(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; },

        async killAgent(id) {
          if (!confirm('Stop this agent?')) return;
          await fetch(`/api/local-claude/agents/${id}`, { method: 'DELETE' });
          if (this.agentStreams[id]) { this.agentStreams[id].close(); delete this.agentStreams[id]; }
          await this.refreshAgents();
        },

        async sendInput(id) {
          const msg = this.inputMessages[id];
          if (!msg) return;
          await fetch(`/api/local-claude/agents/${id}/input`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ input: msg })
          });
          this.inputMessages[id] = '';
          await this.refreshAgents();
          this.subscribeToAgent(id);
        },

        async refreshWorktrees() {
          try {
            const res = await fetch('/api/local-claude/worktrees');
            const data = await res.json();
            this.worktrees = data.worktrees || [];
          } catch (e) {}
        },

        async openInEditor(n) {
          await fetch('/api/local-claude/open-in-editor', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ task_number: n })
          });
        },

        async mergeWorktree(wt) {
          if (!confirm(`Merge ${wt.branch}?`)) return;
          const res = await fetch('/api/local-claude/merge', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ task_number: wt.task_number, branch: wt.branch })
          });
          const data = await res.json();
          if (!res.ok) alert(data.detail);
          else { alert(data.message); await this.refreshWorktrees(); }
        },

        async deleteWorktree(wt) {
          if (!confirm(`Delete ${wt.branch}?`)) return;
          await fetch(`/api/local-claude/worktree?task_number=${wt.task_number}&worktree_path=${encodeURIComponent(wt.path)}`, { method: 'DELETE' });
          await this.refreshWorktrees();
        },

        async refreshDevServers() {
          try {
            const res = await fetch('/api/local-claude/dev-server');
            const data = await res.json();
            this.devServers = data.servers || [];
            this.proxyStatus = data.proxy || this.proxyStatus;
          } catch (e) {}
        },

        async setProxyTarget(id) {
          await fetch(`/api/local-claude/dev-proxy?run_id=${id}`, { method: 'POST' });
          await this.refreshDevServers();
        },

        async stopDevServer(id) {
          await fetch(`/api/local-claude/dev-server?run_id=${id}`, { method: 'DELETE' });
          await this.refreshDevServers();
        },

        async refreshCommits() {
          try {
            const res = await fetch(`/api/local-claude/commits?limit=20&all_branches=${this.showAllBranches}`);
            const data = await res.json();
            this.commits = data.commits || [];
            this.currentBranch = data.branch;
          } catch (e) {}
        },

        selectCommit(c) { this.selectedCommit = this.selectedCommit?.hash === c.hash ? null : c; },

        async viewDiff(c) {
          const res = await fetch(`/api/local-claude/commit-diff/${c.hash}`);
          this.commitDiff = await res.json();
          this.showDiffModal = true;
        },

        formatDiff(d) {
          if (!d) return '';
          return d.split('\n').map(l => {
            if (l.startsWith('+') && !l.startsWith('+++')) return `<div class="diff-add">${this.esc(l)}</div>`;
            if (l.startsWith('-') && !l.startsWith('---')) return `<div class="diff-del">${this.esc(l)}</div>`;
            if (l.startsWith('@@')) return `<div class="diff-hunk mt-3 mb-1">${this.esc(l)}</div>`;
            return `<div class="text-apple-secondary">${this.esc(l)}</div>`;
          }).join('');
        },

        async previewCommit(c) {
          const res = await fetch('/api/local-claude/time-machine/preview', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ commit_sha: c.hash })
          });
          const data = await res.json();
          if (!res.ok) alert(data.detail);
          else { window.open(data.url, '_blank'); await this.refreshPreviews(); }
        },

        async refreshPreviews() {
          try {
            const res = await fetch('/api/local-claude/time-machine/previews');
            const data = await res.json();
            this.previews = data.previews || [];
          } catch (e) {}
        },

        async deletePreview(sha) {
          await fetch(`/api/local-claude/time-machine/preview/${sha}`, { method: 'DELETE' });
          await this.refreshPreviews();
        }
      };
    }
  </script>
</body>
</html>
