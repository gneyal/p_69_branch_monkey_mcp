<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Branch Monkey</title>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=SF+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'system-ui', 'sans-serif'],
            mono: ['SF Mono', 'Menlo', 'Monaco', 'Consolas', 'monospace']
          },
          colors: {
            apple: {
              bg: '#000000',
              surface: '#1c1c1e',
              elevated: '#2c2c2e',
              separator: '#38383a',
              label: '#ffffff',
              secondary: '#8e8e93',
              tertiary: '#48484a',
              blue: '#0a84ff',
              green: '#30d158',
              orange: '#ff9f0a',
              red: '#ff453a',
              purple: '#bf5af2',
              pink: '#ff375f',
              cyan: '#64d2ff',
              yellow: '#ffd60a'
            }
          }
        }
      }
    }
  </script>
  <style>
    [x-cloak] { display: none !important; }

    * {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body {
      background: #000000;
    }

    .surface {
      background: rgba(28, 28, 30, 0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    .elevated {
      background: rgba(44, 44, 46, 0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    .card {
      background: rgba(28, 28, 30, 0.6);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 0.5px solid rgba(255, 255, 255, 0.1);
      transition: all 0.2s ease;
    }

    .card:hover {
      background: rgba(44, 44, 46, 0.6);
    }

    .btn {
      transition: all 0.15s ease;
    }

    .btn:active {
      transform: scale(0.97);
    }

    .btn-primary {
      background: #0a84ff;
    }
    .btn-primary:hover {
      background: #409cff;
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
    }
    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .btn-danger {
      background: rgba(255, 69, 58, 0.15);
      color: #ff453a;
    }
    .btn-danger:hover {
      background: rgba(255, 69, 58, 0.25);
    }

    .btn-success {
      background: rgba(48, 209, 88, 0.15);
      color: #30d158;
    }
    .btn-success:hover {
      background: rgba(48, 209, 88, 0.25);
    }

    .output-scroll {
      max-height: 300px;
      overflow-y: auto;
    }
    .output-scroll::-webkit-scrollbar { width: 6px; }
    .output-scroll::-webkit-scrollbar-track { background: transparent; }
    .output-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
    .output-scroll::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }

    .tab {
      position: relative;
      transition: all 0.2s ease;
    }
    .tab.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 20px;
      height: 2px;
      background: #0a84ff;
      border-radius: 1px;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 100px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-running {
      background: rgba(48, 209, 88, 0.15);
      color: #30d158;
    }
    .status-paused {
      background: rgba(255, 159, 10, 0.15);
      color: #ff9f0a;
    }
    .status-completed {
      background: rgba(10, 132, 255, 0.15);
      color: #0a84ff;
    }
    .status-failed, .status-stopped {
      background: rgba(255, 69, 58, 0.15);
      color: #ff453a;
    }

    .diff-add { color: #30d158; background: rgba(48, 209, 88, 0.1); }
    .diff-del { color: #ff453a; background: rgba(255, 69, 58, 0.1); }
    .diff-hunk { color: #bf5af2; }

    .commit-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #0a84ff;
      position: relative;
    }
    .commit-dot.merge {
      background: #bf5af2;
    }
    .commit-line {
      position: relative;
    }
    .commit-line::before {
      content: '';
      position: absolute;
      left: 3.5px;
      top: 20px;
      bottom: -16px;
      width: 1px;
      background: rgba(255, 255, 255, 0.1);
    }
    .commit-line:last-child::before {
      display: none;
    }

    @keyframes pulse-ring {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(1.5); opacity: 0; }
    }
    .pulse-ring::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: inherit;
      animation: pulse-ring 1.5s ease-out infinite;
    }

    input:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.3);
    }

    .mono {
      font-family: 'SF Mono', Menlo, Monaco, Consolas, monospace;
    }
  </style>
</head>
<body class="text-white min-h-screen font-sans">
  <div x-data="dashboard()" x-init="init()" x-cloak class="min-h-screen">
    <!-- Header -->
    <header class="surface border-b border-white/5 sticky top-0 z-50">
      <div class="max-w-6xl mx-auto px-6 h-14 flex items-center justify-between">
        <div class="flex items-center gap-8">
          <div class="flex items-center gap-2.5">
            <div class="w-7 h-7 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
              <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
              </svg>
            </div>
            <span class="font-semibold text-[15px]">Branch Monkey</span>
          </div>

          <div class="flex items-center gap-4 text-[13px]">
            <div class="flex items-center gap-2">
              <div class="relative">
                <div :class="connected ? 'bg-apple-green' : 'bg-apple-red'" class="w-2 h-2 rounded-full"></div>
                <div x-show="connected" :class="connected ? 'bg-apple-green' : ''" class="absolute inset-0 w-2 h-2 rounded-full pulse-ring"></div>
              </div>
              <span class="text-apple-secondary" x-text="connected ? 'Connected' : 'Disconnected'"></span>
            </div>
            <div class="w-px h-3 bg-white/10"></div>
            <div class="flex items-center gap-1.5">
              <svg :class="claudeInstalled ? 'text-apple-green' : 'text-apple-orange'" class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                <path x-show="claudeInstalled" fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                <path x-show="!claudeInstalled" fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
              </svg>
              <span class="text-apple-secondary">Claude CLI</span>
            </div>
          </div>
        </div>

        <button @click="refreshAll()" class="p-2 -m-2 hover:bg-white/5 rounded-lg transition-colors">
          <svg class="w-4 h-4 text-apple-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
        </button>
      </div>
    </header>

    <!-- Tabs -->
    <nav class="surface border-b border-white/5 sticky top-14 z-40">
      <div class="max-w-6xl mx-auto px-6 flex gap-6">
        <template x-for="t in [
          {id: 'agents', label: 'Agents'},
          {id: 'worktrees', label: 'Worktrees'},
          {id: 'devServers', label: 'Dev Servers'},
          {id: 'gitHistory', label: 'Git History'}
        ]">
          <button
            @click="activeTab = t.id"
            :class="activeTab === t.id ? 'text-white active' : 'text-apple-secondary hover:text-white'"
            class="tab py-3 text-[13px] font-medium transition-colors"
            x-text="t.label"
          ></button>
        </template>
      </div>
    </nav>

    <!-- Content -->
    <main class="max-w-6xl mx-auto px-6 py-6">
      <!-- Agents -->
      <div x-show="activeTab === 'agents'" x-cloak>
        <div x-show="agents.length === 0" class="text-center py-20">
          <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-apple-surface flex items-center justify-center">
            <svg class="w-8 h-8 text-apple-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
            </svg>
          </div>
          <h3 class="text-lg font-semibold mb-1">No Agents Running</h3>
          <p class="text-apple-secondary text-sm">Start an agent from Claude Code or the relay</p>
        </div>

        <div class="space-y-3">
          <template x-for="agent in agents" :key="agent.id">
            <div class="card rounded-2xl overflow-hidden">
              <div class="p-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-xl flex items-center justify-center"
                       :class="{
                         'bg-apple-green/15': agent.status === 'running',
                         'bg-apple-orange/15': agent.status === 'paused',
                         'bg-apple-blue/15': agent.status === 'completed',
                         'bg-apple-red/15': agent.status === 'failed' || agent.status === 'stopped'
                       }">
                    <svg class="w-5 h-5"
                         :class="{
                           'text-apple-green': agent.status === 'running',
                           'text-apple-orange': agent.status === 'paused',
                           'text-apple-blue': agent.status === 'completed',
                           'text-apple-red': agent.status === 'failed' || agent.status === 'stopped'
                         }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                  </div>
                  <div>
                    <div class="flex items-center gap-2">
                      <span class="font-medium text-[15px]" x-text="agent.task_title || 'Agent ' + agent.id"></span>
                      <span x-show="agent.task_number" class="mono text-xs text-apple-secondary bg-white/5 px-1.5 py-0.5 rounded" x-text="'#' + agent.task_number"></span>
                    </div>
                    <div class="flex items-center gap-2 mt-0.5">
                      <span class="mono text-xs text-apple-tertiary" x-text="agent.id"></span>
                      <span x-show="agent.branch" class="text-xs text-apple-purple" x-text="agent.branch"></span>
                    </div>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <span class="status-pill"
                        :class="{
                          'status-running': agent.status === 'running',
                          'status-paused': agent.status === 'paused',
                          'status-completed': agent.status === 'completed',
                          'status-failed': agent.status === 'failed' || agent.status === 'stopped'
                        }">
                    <span :class="agent.status === 'running' ? 'animate-pulse' : ''" class="w-1.5 h-1.5 rounded-full bg-current"></span>
                    <span x-text="agent.status" class="capitalize"></span>
                  </span>
                  <button @click="killAgent(agent.id)" class="btn btn-danger px-3 py-1.5 rounded-lg text-xs font-medium">
                    Stop
                  </button>
                </div>
              </div>

              <div class="px-4 pb-4">
                <div class="bg-black/40 rounded-xl p-3 output-scroll mono text-xs leading-relaxed"
                     :id="'output-' + agent.id"
                     x-html="formatOutput(agentOutput[agent.id] || [])">
                </div>
              </div>

              <div x-show="agent.can_resume && agent.status !== 'running'" class="px-4 pb-4">
                <div class="flex gap-2">
                  <input
                    type="text"
                    x-model="inputMessages[agent.id]"
                    @keyup.enter="sendInput(agent.id)"
                    placeholder="Send follow-up..."
                    class="flex-1 bg-white/5 border border-white/10 rounded-xl px-3 py-2 text-sm placeholder-apple-tertiary transition-all"
                  >
                  <button @click="sendInput(agent.id)" class="btn btn-primary px-4 py-2 rounded-xl text-sm font-medium">
                    Send
                  </button>
                </div>
              </div>
            </div>
          </template>
        </div>
      </div>

      <!-- Worktrees -->
      <div x-show="activeTab === 'worktrees'" x-cloak>
        <div x-show="worktrees.length === 0" class="text-center py-20">
          <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-apple-surface flex items-center justify-center">
            <svg class="w-8 h-8 text-apple-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
            </svg>
          </div>
          <h3 class="text-lg font-semibold mb-1">No Worktrees</h3>
          <p class="text-apple-secondary text-sm">Worktrees are created when agents start tasks</p>
        </div>

        <div class="space-y-2">
          <template x-for="wt in worktrees" :key="wt.path">
            <div class="card rounded-xl p-4">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="w-9 h-9 rounded-lg flex items-center justify-center"
                       :class="wt.merged_to_main ? 'bg-apple-green/15' : 'bg-apple-cyan/15'">
                    <svg class="w-4.5 h-4.5"
                         :class="wt.merged_to_main ? 'text-apple-green' : 'text-apple-cyan'"
                         fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                    </svg>
                  </div>
                  <div>
                    <div class="flex items-center gap-2">
                      <span class="mono text-sm font-medium" x-text="wt.branch || 'detached'"></span>
                      <span x-show="wt.task_number" class="text-xs text-apple-secondary bg-white/5 px-1.5 py-0.5 rounded" x-text="'Task #' + wt.task_number"></span>
                      <span x-show="wt.has_changes" class="text-[10px] px-1.5 py-0.5 rounded-full bg-apple-orange/15 text-apple-orange">Modified</span>
                      <span x-show="wt.merged_to_main" class="text-[10px] px-1.5 py-0.5 rounded-full bg-apple-green/15 text-apple-green">Merged</span>
                    </div>
                    <div x-show="wt.last_commit" class="flex items-center gap-2 mt-1 text-xs text-apple-secondary">
                      <span class="mono text-apple-yellow" x-text="wt.last_commit?.hash"></span>
                      <span class="truncate max-w-xs" x-text="wt.last_commit?.message"></span>
                      <span x-text="wt.last_commit?.date"></span>
                    </div>
                  </div>
                </div>
                <div class="flex items-center gap-1.5">
                  <button @click="openInEditor(wt.task_number)" class="btn btn-secondary px-3 py-1.5 rounded-lg text-xs font-medium">
                    Open
                  </button>
                  <button x-show="!wt.merged_to_main && wt.branch" @click="mergeWorktree(wt)" class="btn btn-success px-3 py-1.5 rounded-lg text-xs font-medium">
                    Merge
                  </button>
                  <button @click="deleteWorktree(wt)" class="btn btn-danger px-3 py-1.5 rounded-lg text-xs font-medium">
                    Delete
                  </button>
                </div>
              </div>
            </div>
          </template>
        </div>
      </div>

      <!-- Dev Servers -->
      <div x-show="activeTab === 'devServers'" x-cloak>
        <div class="space-y-4">
          <!-- Proxy Card -->
          <div class="card rounded-xl p-4">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-lg bg-apple-purple/15 flex items-center justify-center">
                  <svg class="w-4.5 h-4.5 text-apple-purple" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                  </svg>
                </div>
                <div>
                  <div class="font-medium text-sm">Dev Proxy</div>
                  <div class="flex items-center gap-2 mt-0.5 text-xs">
                    <span :class="proxyStatus.running ? 'text-apple-green' : 'text-apple-secondary'" x-text="proxyStatus.running ? 'Active' : 'Inactive'"></span>
                    <template x-if="proxyStatus.running">
                      <span class="text-apple-secondary">
                        <span class="mono">:<span x-text="proxyStatus.proxyPort"></span></span>
                        <template x-if="proxyStatus.targetPort">
                          <span> → <span class="mono">:<span x-text="proxyStatus.targetPort"></span></span></span>
                        </template>
                      </span>
                    </template>
                  </div>
                </div>
              </div>
              <a x-show="proxyStatus.proxyUrl" :href="proxyStatus.proxyUrl" target="_blank" class="btn btn-primary px-3 py-1.5 rounded-lg text-xs font-medium">
                Open
              </a>
            </div>
          </div>

          <div x-show="devServers.length === 0" class="text-center py-16">
            <div class="w-14 h-14 mx-auto mb-3 rounded-2xl bg-apple-surface flex items-center justify-center">
              <svg class="w-7 h-7 text-apple-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2"/>
              </svg>
            </div>
            <h3 class="font-semibold mb-1">No Dev Servers</h3>
            <p class="text-apple-secondary text-sm">Start a server from a worktree</p>
          </div>

          <div class="space-y-2">
            <template x-for="server in devServers" :key="server.runId">
              <div class="card rounded-xl p-4">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-lg flex items-center justify-center"
                         :class="server.isActive ? 'bg-apple-green/15' : 'bg-white/5'">
                      <svg class="w-4.5 h-4.5" :class="server.isActive ? 'text-apple-green' : 'text-apple-secondary'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2"/>
                      </svg>
                    </div>
                    <div>
                      <div class="flex items-center gap-2">
                        <span class="font-medium text-sm" x-text="'Task #' + server.taskNumber"></span>
                        <span class="mono text-xs text-apple-cyan" x-text="':' + server.port"></span>
                        <span x-show="server.isActive" class="text-[10px] px-1.5 py-0.5 rounded-full bg-apple-green/15 text-apple-green animate-pulse">Proxied</span>
                      </div>
                      <div class="text-xs text-apple-tertiary mt-0.5" x-text="server.startedAt"></div>
                    </div>
                  </div>
                  <div class="flex items-center gap-1.5">
                    <button x-show="!server.isActive" @click="setProxyTarget(server.runId)" class="btn btn-secondary px-3 py-1.5 rounded-lg text-xs font-medium">
                      Set Proxy
                    </button>
                    <a :href="server.url" target="_blank" class="btn btn-secondary px-3 py-1.5 rounded-lg text-xs font-medium">
                      Direct
                    </a>
                    <button @click="stopDevServer(server.runId)" class="btn btn-danger px-3 py-1.5 rounded-lg text-xs font-medium">
                      Stop
                    </button>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </div>
      </div>

      <!-- Git History -->
      <div x-show="activeTab === 'gitHistory'" x-cloak>
        <div class="space-y-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3 text-sm">
              <span class="text-apple-secondary">Branch:</span>
              <span class="mono text-apple-purple" x-text="currentBranch"></span>
            </div>
            <label class="flex items-center gap-2 text-sm cursor-pointer">
              <input type="checkbox" x-model="showAllBranches" @change="refreshCommits()" class="w-4 h-4 rounded bg-white/10 border-0 text-apple-blue focus:ring-apple-blue/30">
              <span class="text-apple-secondary">All branches</span>
            </label>
          </div>

          <div class="card rounded-xl overflow-hidden divide-y divide-white/5">
            <template x-for="(commit, index) in commits" :key="commit.hash">
              <div @click="selectCommit(commit)"
                   :class="selectedCommit?.hash === commit.hash ? 'bg-apple-blue/10' : 'hover:bg-white/[0.02]'"
                   class="px-4 py-3 cursor-pointer transition-colors commit-line">
                <div class="flex items-start gap-3">
                  <div class="pt-1">
                    <div class="commit-dot" :class="commit.parents?.length > 1 ? 'merge' : ''"></div>
                  </div>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-1">
                      <span class="mono text-xs text-apple-yellow" x-text="commit.short_hash"></span>
                      <span class="text-sm truncate" x-text="commit.message"></span>
                    </div>
                    <div class="flex items-center gap-3 text-xs text-apple-secondary">
                      <span x-text="commit.author"></span>
                      <span x-text="commit.relative_date"></span>
                      <template x-if="commit.refs">
                        <div class="flex gap-1">
                          <template x-for="ref in commit.refs.split(', ').filter(r => r)" :key="ref">
                            <span class="px-1.5 py-0.5 rounded text-[10px] font-medium"
                                  :class="ref.includes('HEAD') ? 'bg-apple-green/20 text-apple-green' : ref.includes('origin/') ? 'bg-apple-purple/20 text-apple-purple' : 'bg-apple-blue/20 text-apple-blue'"
                                  x-text="ref.replace('HEAD -> ', '')"></span>
                          </template>
                        </div>
                      </template>
                    </div>
                  </div>
                  <div class="flex items-center gap-1">
                    <button @click.stop="viewDiff(commit)" class="btn btn-secondary p-1.5 rounded-lg">
                      <svg class="w-4 h-4 text-apple-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                      </svg>
                    </button>
                    <button @click.stop="previewCommit(commit)" class="btn btn-secondary p-1.5 rounded-lg">
                      <svg class="w-4 h-4 text-apple-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </template>
          </div>

          <div x-show="previews.length > 0">
            <h3 class="text-xs font-medium text-apple-secondary uppercase tracking-wide mb-2">Active Previews</h3>
            <div class="space-y-2">
              <template x-for="preview in previews" :key="preview.sha">
                <div class="card rounded-xl p-3 flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <span class="mono text-xs text-apple-yellow" x-text="preview.sha"></span>
                    <a :href="preview.url" target="_blank" class="mono text-xs text-apple-blue hover:underline" x-text="preview.url"></a>
                  </div>
                  <button @click="deletePreview(preview.sha)" class="btn btn-danger px-2 py-1 rounded text-xs">Stop</button>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Diff Modal -->
    <div x-show="showDiffModal" x-cloak @click.self="showDiffModal = false"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-6">
      <div x-show="showDiffModal"
           x-transition:enter="transition ease-out duration-200"
           x-transition:enter-start="opacity-0 scale-95"
           x-transition:enter-end="opacity-100 scale-100"
           class="surface rounded-2xl max-w-4xl w-full max-h-[80vh] overflow-hidden flex flex-col border border-white/10">
        <div class="px-5 py-4 border-b border-white/5 flex items-center justify-between">
          <div>
            <h3 class="font-semibold" x-text="commitDiff?.message"></h3>
            <span class="mono text-xs text-apple-yellow" x-text="commitDiff?.sha"></span>
          </div>
          <button @click="showDiffModal = false" class="p-1.5 hover:bg-white/5 rounded-lg transition-colors">
            <svg class="w-5 h-5 text-apple-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        <div class="p-5 overflow-auto flex-1">
          <div x-show="commitDiff?.files?.length > 0" class="mb-4 flex flex-wrap gap-2">
            <template x-for="file in commitDiff?.files || []" :key="file.path">
              <span class="mono text-xs bg-black/30 px-2 py-1 rounded-lg border border-white/5">
                <span class="text-apple-secondary" x-text="file.path"></span>
                <span class="text-apple-green ml-1" x-text="'+' + file.insertions"></span>
                <span class="text-apple-red ml-1" x-text="'-' + file.deletions"></span>
              </span>
            </template>
          </div>
          <pre class="mono text-xs bg-black/40 p-4 rounded-xl overflow-auto leading-relaxed" x-html="formatDiff(commitDiff?.diff || '')"></pre>
        </div>
      </div>
    </div>
  </div>

  <script>
    function dashboard() {
      return {
        connected: false,
        claudeInstalled: false,
        activeTab: 'agents',
        agents: [],
        agentOutput: {},
        inputMessages: {},
        agentStreams: {},
        worktrees: [],
        devServers: [],
        proxyStatus: { running: false, proxyPort: 5176, targetPort: null, targetRunId: null },
        commits: [],
        currentBranch: '',
        showAllBranches: false,
        selectedCommit: null,
        commitDiff: null,
        showDiffModal: false,
        previews: [],

        async init() {
          await this.refreshAll();
          setInterval(() => this.refreshAll(), 5000);
        },

        async refreshAll() {
          await Promise.all([
            this.refreshStatus(),
            this.refreshAgents(),
            this.refreshWorktrees(),
            this.refreshDevServers(),
            this.refreshCommits(),
            this.refreshPreviews()
          ]);
        },

        async refreshStatus() {
          try {
            const [statusRes, claudeRes] = await Promise.all([
              fetch('/api/status'),
              fetch('/api/local-claude/check')
            ]);
            await statusRes.json();
            const claude = await claudeRes.json();
            this.connected = true;
            this.claudeInstalled = claude.installed;
          } catch (e) {
            this.connected = false;
          }
        },

        async refreshAgents() {
          try {
            const res = await fetch('/api/local-claude/agents');
            this.agents = await res.json();
            for (const agent of this.agents) {
              if (agent.status === 'running' && !this.agentStreams[agent.id]) {
                this.subscribeToAgent(agent.id);
              }
            }
          } catch (e) {}
        },

        subscribeToAgent(agentId) {
          if (this.agentStreams[agentId]) return;
          const es = new EventSource(`/api/local-claude/agents/${agentId}/stream`);
          this.agentStreams[agentId] = es;
          this.agentOutput[agentId] = this.agentOutput[agentId] || [];

          es.onmessage = (e) => {
            try {
              const data = JSON.parse(e.data);
              if (data.type === 'output') {
                this.agentOutput[agentId].push(data);
                if (this.agentOutput[agentId].length > 500) {
                  this.agentOutput[agentId] = this.agentOutput[agentId].slice(-500);
                }
                this.$nextTick(() => {
                  const el = document.getElementById(`output-${agentId}`);
                  if (el) el.scrollTop = el.scrollHeight;
                });
              } else if (data.type === 'exit' || data.type === 'paused') {
                this.refreshAgents();
                es.close();
                delete this.agentStreams[agentId];
              }
            } catch (e) {}
          };
          es.onerror = () => { es.close(); delete this.agentStreams[agentId]; };
        },

        formatOutput(output) {
          if (!output || output.length === 0) return '<span class="text-apple-tertiary">Waiting for output...</span>';
          return output.map(item => {
            if (!item.data) return '';
            try {
              const p = JSON.parse(item.data);
              if (p.type === 'assistant' && p.message?.content) {
                const c = p.message.content;
                if (Array.isArray(c)) {
                  return c.map(x => {
                    if (x.type === 'text') return `<div class="text-white/90 mb-2">${this.esc(x.text)}</div>`;
                    if (x.type === 'tool_use') return `<div class="text-apple-blue mb-1">→ ${x.name}</div>`;
                    return '';
                  }).join('');
                }
              }
              if (p.type === 'result' && p.result) return `<div class="text-apple-green mb-2">✓ ${this.esc(p.result)}</div>`;
              if (p.type === 'system') return `<div class="text-apple-tertiary text-[10px]">[${p.subtype || 'system'}]</div>`;
              return `<div class="text-apple-tertiary">${this.esc(item.data.substring(0, 150))}${item.data.length > 150 ? '...' : ''}</div>`;
            } catch (e) {
              return `<div class="text-apple-secondary">${this.esc(item.data)}</div>`;
            }
          }).join('');
        },

        esc(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; },

        async killAgent(id) {
          if (!confirm('Stop this agent?')) return;
          await fetch(`/api/local-claude/agents/${id}`, { method: 'DELETE' });
          if (this.agentStreams[id]) { this.agentStreams[id].close(); delete this.agentStreams[id]; }
          await this.refreshAgents();
        },

        async sendInput(id) {
          const msg = this.inputMessages[id];
          if (!msg) return;
          await fetch(`/api/local-claude/agents/${id}/input`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ input: msg })
          });
          this.inputMessages[id] = '';
          await this.refreshAgents();
          this.subscribeToAgent(id);
        },

        async refreshWorktrees() {
          try {
            const res = await fetch('/api/local-claude/worktrees');
            const data = await res.json();
            this.worktrees = data.worktrees || [];
          } catch (e) {}
        },

        async openInEditor(n) {
          await fetch('/api/local-claude/open-in-editor', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ task_number: n })
          });
        },

        async mergeWorktree(wt) {
          if (!confirm(`Merge ${wt.branch}?`)) return;
          const res = await fetch('/api/local-claude/merge', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ task_number: wt.task_number, branch: wt.branch })
          });
          const data = await res.json();
          if (!res.ok) alert(data.detail);
          else { alert(data.message); await this.refreshWorktrees(); }
        },

        async deleteWorktree(wt) {
          if (!confirm(`Delete ${wt.branch}?`)) return;
          await fetch(`/api/local-claude/worktree?task_number=${wt.task_number}&worktree_path=${encodeURIComponent(wt.path)}`, { method: 'DELETE' });
          await this.refreshWorktrees();
        },

        async refreshDevServers() {
          try {
            const res = await fetch('/api/local-claude/dev-server');
            const data = await res.json();
            this.devServers = data.servers || [];
            this.proxyStatus = data.proxy || this.proxyStatus;
          } catch (e) {}
        },

        async setProxyTarget(id) {
          await fetch(`/api/local-claude/dev-proxy?run_id=${id}`, { method: 'POST' });
          await this.refreshDevServers();
        },

        async stopDevServer(id) {
          await fetch(`/api/local-claude/dev-server?run_id=${id}`, { method: 'DELETE' });
          await this.refreshDevServers();
        },

        async refreshCommits() {
          try {
            const res = await fetch(`/api/local-claude/commits?limit=20&all_branches=${this.showAllBranches}`);
            const data = await res.json();
            this.commits = data.commits || [];
            this.currentBranch = data.branch;
          } catch (e) {}
        },

        selectCommit(c) { this.selectedCommit = this.selectedCommit?.hash === c.hash ? null : c; },

        async viewDiff(c) {
          const res = await fetch(`/api/local-claude/commit-diff/${c.hash}`);
          this.commitDiff = await res.json();
          this.showDiffModal = true;
        },

        formatDiff(d) {
          if (!d) return '';
          return d.split('\n').map(l => {
            if (l.startsWith('+') && !l.startsWith('+++')) return `<div class="diff-add">${this.esc(l)}</div>`;
            if (l.startsWith('-') && !l.startsWith('---')) return `<div class="diff-del">${this.esc(l)}</div>`;
            if (l.startsWith('@@')) return `<div class="diff-hunk mt-3 mb-1">${this.esc(l)}</div>`;
            return `<div class="text-apple-secondary">${this.esc(l)}</div>`;
          }).join('');
        },

        async previewCommit(c) {
          const res = await fetch('/api/local-claude/time-machine/preview', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ commit_sha: c.hash })
          });
          const data = await res.json();
          if (!res.ok) alert(data.detail);
          else { window.open(data.url, '_blank'); await this.refreshPreviews(); }
        },

        async refreshPreviews() {
          try {
            const res = await fetch('/api/local-claude/time-machine/previews');
            const data = await res.json();
            this.previews = data.previews || [];
          } catch (e) {}
        },

        async deletePreview(sha) {
          await fetch(`/api/local-claude/time-machine/preview/${sha}`, { method: 'DELETE' });
          await this.refreshPreviews();
        }
      };
    }
  </script>
</body>
</html>
